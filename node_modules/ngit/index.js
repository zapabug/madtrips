#!/usr/bin/env node
var spawn = require('child_process').spawn
var exec = require('child_process').exec
var argv = process.argv
argv.splice(0,2)
var KEY_PATH_NAME='SSH_KEY_PATH'
var sshKeyPath = process.env['SSH_KEY_PATH']

if (!sshKeyPath) {
  throw new Error('Error: ' + KEY_PATH_NAME + ' environment variable must be set')
}
if (argv.length === 0) {
  var message = 'you must supply an argument to git...naw we are the knights who say'
  var error = new Error(message)
  throw error
}

var sshCommand = 'ssh-agent bash -c "ssh-add ~/.ssh/id_rsa"'

exec(sshCommand, {}, function(err, stderr, stdout) {
  if (err) {
    console.log(stderr)
    console.log(stdout)
    throw err
  }

  var child = spawn('git', argv, {
    stdio: 'pipe'
  })


  child.stderr.pipe(process.stderr)
  child.stdout.pipe(process.stdout)

})

