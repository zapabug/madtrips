"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[475],{8839:(t,e,i)=>{i.d(e,{Ay:()=>eo,QB:()=>to,uk:()=>tK});var s,n=i(1451),r=i(6563),a=i(2596),o=i(210),h=i(9989),l=i(4132),u=i(6327);i(9080);var c=i(6152),d=(t=>(t[t.Metadata=0]="Metadata",t[t.Text=1]="Text",t[t.RecommendRelay=2]="RecommendRelay",t[t.Contacts=3]="Contacts",t[t.EncryptedDirectMessage=4]="EncryptedDirectMessage",t[t.EventDeletion=5]="EventDeletion",t[t.Repost=6]="Repost",t[t.Reaction=7]="Reaction",t[t.BadgeAward=8]="BadgeAward",t[t.GroupChat=9]="GroupChat",t[t.GroupNote=11]="GroupNote",t[t.GroupReply=12]="GroupReply",t[t.GiftWrapSeal=13]="GiftWrapSeal",t[t.PrivateDirectMessage=14]="PrivateDirectMessage",t[t.Image=20]="Image",t[t.Vanish=62]="Vanish",t[t.GiftWrap=1059]="GiftWrap",t[t.GenericRepost=16]="GenericRepost",t[t.ChannelCreation=40]="ChannelCreation",t[t.ChannelMetadata=41]="ChannelMetadata",t[t.ChannelMessage=42]="ChannelMessage",t[t.ChannelHideMessage=43]="ChannelHideMessage",t[t.ChannelMuteUser=44]="ChannelMuteUser",t[t.GenericReply=1111]="GenericReply",t[t.Media=1063]="Media",t[t.Report=1984]="Report",t[t.Label=1985]="Label",t[t.DVMReqTextExtraction=5e3]="DVMReqTextExtraction",t[t.DVMReqTextSummarization=5001]="DVMReqTextSummarization",t[t.DVMReqTextTranslation=5002]="DVMReqTextTranslation",t[t.DVMReqTextGeneration=5050]="DVMReqTextGeneration",t[t.DVMReqImageGeneration=5100]="DVMReqImageGeneration",t[t.DVMReqTextToSpeech=5250]="DVMReqTextToSpeech",t[t.DVMReqDiscoveryNostrContent=5300]="DVMReqDiscoveryNostrContent",t[t.DVMReqDiscoveryNostrPeople=5301]="DVMReqDiscoveryNostrPeople",t[t.DVMReqTimestamping=5900]="DVMReqTimestamping",t[t.DVMEventSchedule=5905]="DVMEventSchedule",t[t.DVMJobFeedback=7e3]="DVMJobFeedback",t[t.Subscribe=7001]="Subscribe",t[t.Unsubscribe=7002]="Unsubscribe",t[t.SubscriptionReceipt=7003]="SubscriptionReceipt",t[t.CashuReserve=7373]="CashuReserve",t[t.CashuQuote=7374]="CashuQuote",t[t.CashuToken=7375]="CashuToken",t[t.CashuWalletTx=7376]="CashuWalletTx",t[t.GroupAdminAddUser=9e3]="GroupAdminAddUser",t[t.GroupAdminRemoveUser=9001]="GroupAdminRemoveUser",t[t.GroupAdminEditMetadata=9002]="GroupAdminEditMetadata",t[t.GroupAdminEditStatus=9006]="GroupAdminEditStatus",t[t.GroupAdminCreateGroup=9007]="GroupAdminCreateGroup",t[t.GroupAdminRequestJoin=9021]="GroupAdminRequestJoin",t[t.MuteList=1e4]="MuteList",t[t.PinList=10001]="PinList",t[t.RelayList=10002]="RelayList",t[t.BookmarkList=10003]="BookmarkList",t[t.CommunityList=10004]="CommunityList",t[t.PublicChatList=10005]="PublicChatList",t[t.BlockRelayList=10006]="BlockRelayList",t[t.SearchRelayList=10007]="SearchRelayList",t[t.SimpleGroupList=10009]="SimpleGroupList",t[t.InterestList=10015]="InterestList",t[t.CashuMintList=10019]="CashuMintList",t[t.EmojiList=10030]="EmojiList",t[t.DirectMessageReceiveRelayList=10050]="DirectMessageReceiveRelayList",t[t.BlossomList=10063]="BlossomList",t[t.NostrWaletConnectInfo=13194]="NostrWaletConnectInfo",t[t.TierList=17e3]="TierList",t[t.CashuWallet=17375]="CashuWallet",t[t.FollowSet=3e4]="FollowSet",t[t.CategorizedPeopleList=3e4]="CategorizedPeopleList",t[t.CategorizedBookmarkList=30001]="CategorizedBookmarkList",t[t.RelaySet=30002]="RelaySet",t[t.CategorizedRelayList=30002]="CategorizedRelayList",t[t.BookmarkSet=30003]="BookmarkSet",t[t.CurationSet=30004]="CurationSet",t[t.ArticleCurationSet=30004]="ArticleCurationSet",t[t.VideoCurationSet=30005]="VideoCurationSet",t[t.ImageCurationSet=30006]="ImageCurationSet",t[t.InterestSet=30015]="InterestSet",t[t.InterestsList=30015]="InterestsList",t[t.EmojiSet=30030]="EmojiSet",t[t.ModularArticle=30040]="ModularArticle",t[t.ModularArticleItem=30041]="ModularArticleItem",t[t.Wiki=30818]="Wiki",t[t.Draft=31234]="Draft",t[t.SubscriptionTier=37001]="SubscriptionTier",t[t.EcashMintRecommendation=38e3]="EcashMintRecommendation",t[t.HighlightSet=39802]="HighlightSet",t[t.CategorizedHighlightList=39802]="CategorizedHighlightList",t[t.Nutzap=9321]="Nutzap",t[t.ZapRequest=9734]="ZapRequest",t[t.Zap=9735]="Zap",t[t.Highlight=9802]="Highlight",t[t.ClientAuth=22242]="ClientAuth",t[t.NostrWalletConnectReq=23194]="NostrWalletConnectReq",t[t.NostrWalletConnectRes=23195]="NostrWalletConnectRes",t[t.NostrConnect=24133]="NostrConnect",t[t.BlossomUpload=24242]="BlossomUpload",t[t.HttpAuth=27235]="HttpAuth",t[t.ProfileBadge=30008]="ProfileBadge",t[t.BadgeDefinition=30009]="BadgeDefinition",t[t.MarketStall=30017]="MarketStall",t[t.MarketProduct=30018]="MarketProduct",t[t.Article=30023]="Article",t[t.AppSpecificData=30078]="AppSpecificData",t[t.Classified=30402]="Classified",t[t.HorizontalVideo=34235]="HorizontalVideo",t[t.VerticalVideo=34236]="VerticalVideo",t[t.LegacyCashuWallet=37375]="LegacyCashuWallet",t[t.GroupMetadata=39e3]="GroupMetadata",t[t.GroupAdmins=39001]="GroupAdmins",t[t.GroupMembers=39002]="GroupMembers",t[t.AppRecommendation=31989]="AppRecommendation",t[t.AppHandler=31990]="AppHandler",t))(d||{});function p(t,e,i="write"){if(!t.outboxTracker)return;let s=t.outboxTracker.data.get(e);if(s)return"write"===i?s.writeRelays:s.readRelays}async function g(t,e,i="write"){if(t.outboxTracker)return t.outboxTracker.data.has(e)||await t.outboxTracker.trackUsers([e]),p(t,e,i)}function f(t,e,i,{count:s,preferredRelays:n}={}){s??=2,n??=new Set;let r=t.pool,a=r.connectedRelays();a.forEach(t=>{n.add(t.url)});let o=new Map,{pubkeysToRelays:h,authorsMissingRelays:l}=function(t,e,i="read"){let s=new Map,n=new Set;return e.forEach(e=>{let r=p(t,e,i);r&&r.size>0?(r.forEach(t=>{(s.get(t)||new Set).add(e)}),s.set(e,r)):n.add(e)}),{pubkeysToRelays:s,authorsMissingRelays:n}}(t,e,i),u=function(t,e){let i=new Map;return e.forEach(e=>{let s=p(t,e);s&&s.forEach(t=>{let e=i.get(t)||0;i.set(t,e+1)})}),Array.from(i.entries()).sort((t,e)=>e[1]-t[1]).map(t=>t[0])}(t,e),c=(t,e)=>{let i=o.get(e)||[];i.push(t),o.set(e,i)};for(let[t,e]of h.entries()){let i=s;for(let s of a)e.has(s.url)&&(c(t,s.url),i--);for(let s of e)o.has(s)&&(c(t,s),i--);if(!(i<=0))for(let s of u){if(i<=0)break;e.has(s)&&(c(t,s),i--)}}for(let t of l)r.permanentAndConnectedRelays().forEach(e=>{let i=o.get(e.url)||[];i.push(t),o.set(e.url,i)});return o}function y(t){try{return m(t)}catch{return}}function m(t){let e=function(t,e={}){if("string"!=typeof(e={defaultProtocol:"http",normalizeProtocol:!0,forceHttp:!1,forceHttps:!1,stripAuthentication:!0,stripHash:!1,stripTextFragment:!0,stripWWW:!0,removeQueryParameters:[/^utm_\w+/i],removeTrailingSlash:!0,removeSingleSlash:!0,removeDirectoryIndex:!1,removeExplicitPort:!1,sortQueryParameters:!0,...e}).defaultProtocol||e.defaultProtocol.endsWith(":")||(e.defaultProtocol=`${e.defaultProtocol}:`),t=t.trim(),/^data:/i.test(t))return R(t,e);if(v(t))return t;let i=t.startsWith("//");!i&&/^\.*\//.test(t)||(t=t.replace(/^(?!(?:\w+:)?\/\/)|^\/\//,e.defaultProtocol));let s=new URL(t);if(s.hostname=s.hostname.toLowerCase(),e.forceHttp&&e.forceHttps)throw Error("The `forceHttp` and `forceHttps` options cannot be used together");if(e.forceHttp&&"https:"===s.protocol&&(s.protocol="http:"),e.forceHttps&&"http:"===s.protocol&&(s.protocol="https:"),e.stripAuthentication&&(s.username="",s.password=""),e.stripHash?s.hash="":e.stripTextFragment&&(s.hash=s.hash.replace(/#?:~:text.*?$/i,"")),s.pathname){let t=/\b[a-z][a-z\d+\-.]{1,50}:\/\//g,e=0,i="";for(;;){let n=t.exec(s.pathname);if(!n)break;let r=n[0],a=n.index;i+=s.pathname.slice(e,a).replace(/\/{2,}/g,"/"),i+=r,e=a+r.length}i+=s.pathname.slice(e,s.pathname.length).replace(/\/{2,}/g,"/"),s.pathname=i}if(s.pathname)try{s.pathname=decodeURI(s.pathname)}catch{}if(!0===e.removeDirectoryIndex&&(e.removeDirectoryIndex=[/^index\.[a-z]+$/]),Array.isArray(e.removeDirectoryIndex)&&e.removeDirectoryIndex.length>0){let t=s.pathname.split("/");k(t[t.length-1],e.removeDirectoryIndex)&&(s.pathname=(t=t.slice(0,-1)).slice(1).join("/")+"/")}if(s.hostname&&(s.hostname=s.hostname.replace(/\.$/,""),e.stripWWW&&/^www\.(?!www\.)[a-z\-\d]{1,63}\.[a-z.\-\d]{2,63}$/.test(s.hostname)&&(s.hostname=s.hostname.replace(/^www\./,""))),Array.isArray(e.removeQueryParameters))for(let t of[...s.searchParams.keys()])k(t,e.removeQueryParameters)&&s.searchParams.delete(t);if(Array.isArray(e.keepQueryParameters)||!0!==e.removeQueryParameters||(s.search=""),Array.isArray(e.keepQueryParameters)&&e.keepQueryParameters.length>0)for(let t of[...s.searchParams.keys()])k(t,e.keepQueryParameters)||s.searchParams.delete(t);if(e.sortQueryParameters){s.searchParams.sort();try{s.search=decodeURIComponent(s.search)}catch{}}e.removeTrailingSlash&&(s.pathname=s.pathname.replace(/\/$/,"")),e.removeExplicitPort&&s.port&&(s.port="");let n=t;return t=s.toString(),e.removeSingleSlash||"/"!==s.pathname||n.endsWith("/")||""!==s.hash||(t=t.replace(/\/$/,"")),(e.removeTrailingSlash||"/"===s.pathname)&&""===s.hash&&e.removeSingleSlash&&(t=t.replace(/\/$/,"")),i&&!e.normalizeProtocol&&(t=t.replace(/^http:\/\//,"//")),e.stripProtocol&&(t=t.replace(/^(?:https?:)?\/\//,"")),t}(t,{stripAuthentication:!1,stripWWW:!1,stripHash:!0});return e.endsWith("/")||(e+="/"),e}function b(t){let e=new Set;for(let i of t)try{e.add(m(i))}catch{}return Array.from(e)}var k=(t,e)=>e.some(e=>e instanceof RegExp?e.test(t):e===t),w=new Set(["https:","http:","file:"]),v=t=>{try{let{protocol:e}=new URL(t);return e.endsWith(":")&&!e.includes(".")&&!w.has(e)}catch{return!1}},R=(t,{stripHash:e})=>{let i=/^data:(?<type>[^,]*?),(?<data>[^#]*?)(?:#(?<hash>.*))?$/.exec(t);if(!i)throw Error(`Invalid URL: ${t}`);let s=i.groups?.type??"",n=i.groups?.data??"",r=i.groups?.hash??"",a=s.split(";");r=e?"":r;let o=!1;"base64"===a[a.length-1]&&(a.pop(),o=!0);let h=a.shift()?.toLowerCase()??"",l=[...a.map(t=>{let[e,i=""]=t.split("=").map(t=>t.trim());return"charset"===e&&"us-ascii"===(i=i.toLowerCase())?"":`${e}${i?`=${i}`:""}`}).filter(Boolean)];return o&&l.push("base64"),(l.length>0||h&&"text/plain"!==h)&&l.unshift(h),`data:${l.join(";")},${o?n.trim():n}${r?`#${r}`:""}`},E=class{ndkRelay;ws;_status;timeoutMs;connectedAt;_connectionStats={attempts:0,success:0,durations:[]};debug;netDebug;connectTimeout;reconnectTimeout;ndk;openSubs=new Map;openCountRequests=new Map;openEventPublishes=new Map;serial=0;baseEoseTimeout=4400;constructor(t,e){this.ndkRelay=t,this._status=1;let i=Math.floor(1e3*Math.random());this.debug=this.ndkRelay.debug.extend("connectivity"+i),this.ndk=e}async connect(t,e=!0){if(2!==this._status&&1!==this._status||this.reconnectTimeout){this.debug("Relay requested to be connected but was in state %s or it had a reconnect timeout",this._status);return}this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=void 0),this.connectTimeout&&(clearTimeout(this.connectTimeout),this.connectTimeout=void 0),t??=this.timeoutMs,!this.timeoutMs&&t&&(this.timeoutMs=t),this.timeoutMs&&(this.connectTimeout=setTimeout(()=>this.onConnectionError(e),this.timeoutMs));try{this.updateConnectionStats.attempt(),1===this._status?this._status=4:this._status=2,this.ws=new WebSocket(this.ndkRelay.url),this.ws.onopen=this.onConnect.bind(this),this.ws.onclose=this.onDisconnect.bind(this),this.ws.onmessage=this.onMessage.bind(this),this.ws.onerror=this.onError.bind(this)}catch(t){throw this.debug(`Failed to connect to ${this.ndkRelay.url}`,t),this._status=1,e?this.handleReconnection():this.ndkRelay.emit("delayed-connect",1728e5),t}}disconnect(){this._status=0;try{this.ws?.close()}catch(t){this.debug("Failed to disconnect",t),this._status=1}}onConnectionError(t){this.debug(`Error connecting to ${this.ndkRelay.url}`,this.timeoutMs),t&&!this.reconnectTimeout&&this.handleReconnection()}onConnect(){this.netDebug?.("connected",this.ndkRelay),this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=void 0),this.connectTimeout&&(clearTimeout(this.connectTimeout),this.connectTimeout=void 0),this.updateConnectionStats.connected(),this._status=5,this.ndkRelay.emit("connect"),this.ndkRelay.emit("ready")}onDisconnect(){this.netDebug?.("disconnected",this.ndkRelay),this.updateConnectionStats.disconnected(),5===this._status&&this.handleReconnection(),this._status=1,this.ndkRelay.emit("disconnect")}onMessage(t){this.netDebug?.(t.data,this.ndkRelay,"recv");try{let e=JSON.parse(t.data),[i,s,...n]=e;switch(i){case"EVENT":{let t=this.openSubs.get(s),i=e[2];if(!t){this.debug(`Received event for unknown subscription ${s}`);return}t.onevent(i);return}case"COUNT":{let t=e[2],i=this.openCountRequests.get(s);i&&(i.resolve(t.count),this.openCountRequests.delete(s));return}case"EOSE":{let t=this.openSubs.get(s);if(!t)return;t.oneose(s);return}case"OK":{let t=e[2],i=e[3],n=this.openEventPublishes.get(s),r=n?.pop();if(!n||!r){this.debug("Received OK for unknown event publish",s);return}t?r.resolve(i):r.reject(Error(i)),0===n.length?this.openEventPublishes.delete(s):this.openEventPublishes.set(s,n);return}case"CLOSED":{let t=this.openSubs.get(s);if(!t)return;t.onclosed(e[2]);return}case"NOTICE":this.onNotice(e[1]);return;case"AUTH":this.onAuthRequested(e[1]);return}}catch(t){this.debug(`Error parsing message from ${this.ndkRelay.url}: ${t.message}`,t?.stack);return}}async onAuthRequested(t){let e=this.ndkRelay.authPolicy??this.ndk?.relayAuthDefaultPolicy;if(this.debug("Relay requested authentication",{havePolicy:!!e}),7===this._status){this.debug("Already authenticating, ignoring");return}if(this._status=6,e){if(this._status>=5){let i;this._status=7;try{i=await e(this.ndkRelay,t)}catch(t){this.debug("Authentication policy threw an error",t),i=!1}if(this.debug("Authentication policy returned",!!i),i instanceof to||!0===i){i instanceof to&&await this.auth(i);let e=async()=>{if(this._status>=5&&this._status<8){let e=new to(this.ndk);e.kind=22242,e.tags=[["relay",this.ndkRelay.url],["challenge",t]],await e.sign(),this.auth(e).then(()=>{this._status=8,this.ndkRelay.emit("authed"),this.debug("Authentication successful")}).catch(t=>{this._status=6,this.ndkRelay.emit("auth:failed",t),this.debug("Authentication failed",t)})}else this.debug("Authentication failed, it changed status, status is %d",this._status)};!0===i&&(this.ndk?.signer?e().catch(t=>{console.error("Error authenticating",t)}):(this.debug("No signer available for authentication localhost"),this.ndk?.once("signer:ready",e))),this._status=5,this.ndkRelay.emit("authed")}}}else this.ndkRelay.emit("auth",t)}onError(t){this.debug(`WebSocket error on ${this.ndkRelay.url}:`,t)}get status(){return this._status}isAvailable(){return 5===this._status}isFlapping(){let t=this._connectionStats.durations;if(t.length%3!=0)return!1;let e=t.reduce((t,e)=>t+e,0)/t.length;return 1e3>Math.sqrt(t.map(t=>Math.pow(t-e,2)).reduce((t,e)=>t+e,0)/t.length)}async onNotice(t){this.ndkRelay.emit("notice",t)}handleReconnection(t=0){if(this.reconnectTimeout)return;if(this.isFlapping()){this.ndkRelay.emit("flapping",this._connectionStats),this._status=3;return}let e=this.connectedAt?Math.max(0,6e4-(Date.now()-this.connectedAt)):5e3*(this._connectionStats.attempts+1);this.reconnectTimeout=setTimeout(()=>{this.reconnectTimeout=void 0,this._status=2,this.connect().catch(e=>{t<5?setTimeout(()=>{this.handleReconnection(t+1)},1e3*(t+1)^4):this.debug("Reconnect failed")})},e),this.ndkRelay.emit("delayed-connect",e),this.debug("Reconnecting in",e),this._connectionStats.nextReconnectAt=Date.now()+e}async send(t){this._status>=5&&this.ws?.readyState===WebSocket.OPEN?(this.ws?.send(t),this.netDebug?.(t,this.ndkRelay,"send")):this.debug(`Not connected to ${this.ndkRelay.url} (%d), not sending message ${t}`,this._status)}async auth(t){let e=new Promise((e,i)=>{let s=this.openEventPublishes.get(t.id)??[];s.push({resolve:e,reject:i}),this.openEventPublishes.set(t.id,s)});return this.send('["AUTH",'+JSON.stringify(t.rawEvent())+"]"),e}async publish(t){let e=new Promise((e,i)=>{let s=this.openEventPublishes.get(t.id)??[];s.length>0&&console.warn("Duplicate event publishing detected, you are publishing event "+t.id+" twice"),s.push({resolve:e,reject:i}),this.openEventPublishes.set(t.id,s)});return this.send('["EVENT",'+JSON.stringify(t)+"]"),e}async count(t,e){this.serial++;let i=e?.id||"count:"+this.serial,s=new Promise((t,e)=>{this.openCountRequests.set(i,{resolve:t,reject:e})});return this.send('["COUNT","'+i+'",'+JSON.stringify(t).substring(1)),s}close(t,e){this.send('["CLOSE","'+t+'"]');let i=this.openSubs.get(t);this.openSubs.delete(t),i&&i.onclose(e)}req(t){this.send('["REQ","'+t.subId+'",'+JSON.stringify(t.executeFilters).substring(1)),this.openSubs.set(t.subId,t)}updateConnectionStats={connected:()=>{this._connectionStats.success++,this._connectionStats.connectedAt=Date.now()},disconnected:()=>{this._connectionStats.connectedAt&&(this._connectionStats.durations.push(Date.now()-this._connectionStats.connectedAt),this._connectionStats.durations.length>100&&this._connectionStats.durations.shift()),this._connectionStats.connectedAt=void 0},attempt:()=>{this._connectionStats.attempts++,this._connectionStats.connectedAt=Date.now()}};get connectionStats(){return this._connectionStats}get url(){return this.ndkRelay.url}get connected(){return this._status>=5&&this.ws?.readyState===WebSocket.OPEN}},T=class{ndkRelay;debug;constructor(t){this.ndkRelay=t,this.debug=t.debug.extend("publisher")}async publish(t,e=2500){let i,s,n;let r=()=>new Promise((e,i)=>{try{this.publishEvent(t).then(i=>{this.ndkRelay.emit("published",t),t.emit("relay:published",this.ndkRelay),e(!0)}).catch(i)}catch(t){i(t)}}),a=new Promise((t,s)=>{i=setTimeout(()=>{i=void 0,s(Error("Timeout: "+e+"ms"))},e)}),o=()=>{r().then(t=>s(t)).catch(t=>n(t))},h=e=>{throw this.ndkRelay.debug("Publish failed",e,t.id),this.ndkRelay.emit("publish:failed",t,e),t.emit("relay:publish:failed",this.ndkRelay,e),e},l=()=>{i&&clearTimeout(i),this.ndkRelay.removeListener("connect",o)};return this.ndkRelay.status>=5?Promise.race([r(),a]).catch(h).finally(l):(this.ndkRelay.status<=1?(console.warn("Relay is disconnected, trying to connect to publish an event",this.ndkRelay.url),this.ndkRelay.connect()):console.warn("Relay not connected, waiting for connection to publish an event",this.ndkRelay.url),Promise.race([new Promise((t,e)=>{s=t,n=e,this.ndkRelay.once("connect",o)}),a]).catch(h).finally(l))}async publishEvent(t){return this.ndkRelay.connectivity.publish(t.rawEvent())}},S=class{fingerprint;items=new Map;topSubManager;debug;status=0;onClose;relay;eosed=!1;executionTimer;fireTime;delayType;executeFilters;id=Math.random().toString(36).substring(7);constructor(t,e,i){this.relay=t,this.topSubManager=i,this.debug=t.debug.extend("subscription-"+this.id),this.fingerprint=e||Math.random().toString(36).substring(7)}_subId;get subId(){return this._subId||(this._subId=this.fingerprint.slice(0,15)),this._subId}subIdParts=new Set;addSubIdPart(t){this.subIdParts.add(t)}addItem(t,e){if(this.debug("Adding item",{filters:e,internalId:t.internalId,status:this.status,fingerprint:this.fingerprint,id:this.subId,items:this.items,itemsSize:this.items.size}),!this.items.has(t.internalId))switch(t.on("close",this.removeItem.bind(this,t)),this.items.set(t.internalId,{subscription:t,filters:e}),3!==this.status&&t.subId&&(!this._subId||this._subId.length<48)&&(0===this.status||1===this.status)&&this.addSubIdPart(t.subId),this.status){case 0:case 1:this.evaluateExecutionPlan(t);break;case 3:console.log("BUG: This should not happen: This subscription needs to catch up with a subscription that was already running",e);break;case 4:throw this.debug("Subscription is closed, cannot add new items %o (%o)",t,e),Error("Cannot add new items to a closed subscription")}}removeItem(t){this.items.delete(t.internalId),0===this.items.size&&this.eosed&&(this.close(),this.cleanup())}close(){if(4===this.status)return;let t=this.status;if(this.status=4,3===t)try{this.relay.close(this.subId)}catch(t){this.debug("Error closing subscription",t,this)}else this.debug("Subscription wanted to close but it wasn't running, this is probably ok",{subId:this.subId,prevStatus:t,sub:this});this.cleanup()}cleanup(){this.executionTimer&&clearTimeout(this.executionTimer),this.relay.off("ready",this.executeOnRelayReady),this.relay.off("authed",this.reExecuteAfterAuth),this.onClose&&this.onClose(this)}evaluateExecutionPlan(t){if(!t.isGroupable()||t.filters.find(t=>!!t.limit)&&(this.executeFilters=this.compileFilters(),this.executeFilters.length>=10)){this.status=1,this.execute();return}let e=t.groupableDelay,i=t.groupableDelayType;if(!e)throw Error("Cannot group a subscription without a delay");if(0===this.status)this.schedule(e,i);else{let t=this.delayType,s=this.fireTime-Date.now();if("at-least"===t&&"at-least"===i)s<e&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(e,i));else if("at-least"===t&&"at-most"===i)s>e&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(e,i));else if("at-most"===t&&"at-most"===i)s>e&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(e,i));else if("at-most"===t&&"at-least"===i)s>e&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(e,i));else throw Error("Unknown delay type combination "+t+" "+i)}}schedule(t,e){this.status=1;let i=Date.now();this.fireTime=i+t,this.delayType=e;let s=setTimeout(this.execute.bind(this),t);"at-least"===e&&(this.executionTimer=s)}executeOnRelayReady=()=>{if(2===this.status){if(0===this.items.size){this.debug("No items to execute; this relay was probably too slow to respond and the caller gave up",{status:this.status,fingerprint:this.fingerprint,items:this.items,itemsSize:this.items.size,id:this.id,subId:this.subId}),this.cleanup();return}this.debug("Executing on relay ready",{status:this.status,fingerprint:this.fingerprint,items:this.items,itemsSize:this.items.size}),this.status=1,this.execute()}};finalizeSubId(){this.subIdParts.size>0?this._subId=Array.from(this.subIdParts).join("-"):this._subId=this.fingerprint.slice(0,15),this._subId+="-"+Math.random().toString(36).substring(2,7)}reExecuteAfterAuth=(()=>{let t=this.subId;this.debug("Re-executing after auth",this.items.size),this.eosed?this.relay.close(this.subId):this.debug("We are abandoning an opened subscription, once it EOSE's, the handler will close it",{oldSubId:t}),this._subId=void 0,this.status=1,this.execute(),this.debug("Re-executed after auth %s \uD83D\uDC49 %s",t,this.subId)}).bind(this);execute(){if(1===this.status){if(this.relay.connected)this.relay.status<8&&this.relay.once("authed",this.reExecuteAfterAuth);else{this.status=2,this.debug("Waiting for relay to be ready",{status:this.status,id:this.subId,fingerprint:this.fingerprint,items:this.items,itemsSize:this.items.size}),this.relay.once("ready",this.executeOnRelayReady);return}this.status=3,this.finalizeSubId(),this.executeFilters=this.compileFilters(),this.relay.req(this)}}onstart(){}onevent(t){this.topSubManager.dispatchEvent(t,this.relay)}oneose(t){if(this.eosed=!0,t!==this.subId){this.debug("Received EOSE for an abandoned subscription",t,this.subId),this.relay.close(t);return}for(let{subscription:t}of(0===this.items.size&&this.close(),this.items.values()))t.eoseReceived(this.relay),t.closeOnEose&&(this.debug("Removing item because of EOSE",{filters:t.filters,internalId:t.internalId,status:this.status,fingerprint:this.fingerprint,items:this.items,itemsSize:this.items.size}),this.removeItem(t))}onclose(t){this.status=4}onclosed(t){if(t)for(let{subscription:e}of this.items.values())e.closedReceived(this.relay,t)}compileFilters(){let t=[],e=Array.from(this.items.values()).map(t=>t.filters);if(!e[0])return this.debug("\uD83D\uDC40 No filters to merge",this.items),console.error("BUG: No filters to merge!",this.items),[];let i=e[0].length;for(let s=0;s<i;s++){let i=e.map(t=>t[s]);t.push(...function(t){let e=[],i={};return(t.filter(t=>!!t.limit).forEach(t=>e.push(t)),0===(t=t.filter(t=>!t.limit)).length)?e:(t.forEach(t=>{Object.entries(t).forEach(([t,e])=>{Array.isArray(e)?void 0===i[t]?i[t]=[...e]:i[t]=Array.from(new Set([...i[t],...e])):i[t]=e})}),[...e,i])}(i))}return t}},A=class{relay;subscriptions;generalSubManager;constructor(t,e){this.relay=t,this.subscriptions=new Map,this.generalSubManager=e}addSubscription(t,e){let i;if(t.isGroupable()){let s=function(t,e){let i=[];for(let e of t){let t=Object.entries(e||{}).map(([t,e])=>["since","until"].includes(t)?t+":"+e:t).sort().join("-");i.push(t)}let s=e?"+":"";return s+i.join("|")}(e,t.closeOnEose);s&&(i=(this.subscriptions.get(s)||[]).find(t=>t.status<3)),i??=this.createSubscription(t,e,s)}else i=this.createSubscription(t,e);i.addItem(t,e)}createSubscription(t,e,i){let s=new S(this.relay,i||null,this.generalSubManager);s.onClose=this.onRelaySubscriptionClose.bind(this);let n=this.subscriptions.get(s.fingerprint)??[];return this.subscriptions.set(s.fingerprint,[...n,s]),s}onRelaySubscriptionClose(t){let e=this.subscriptions.get(t.fingerprint)??[];e?1===e.length?this.subscriptions.delete(t.fingerprint):(e=e.filter(e=>e.id!==t.id),this.subscriptions.set(t.fingerprint,e)):console.warn("Unexpectedly did not find a subscription with fingerprint",t.fingerprint)}},_=(t=>(t[t.DISCONNECTING=0]="DISCONNECTING",t[t.DISCONNECTED=1]="DISCONNECTED",t[t.RECONNECTING=2]="RECONNECTING",t[t.FLAPPING=3]="FLAPPING",t[t.CONNECTING=4]="CONNECTING",t[t.CONNECTED=5]="CONNECTED",t[t.AUTH_REQUESTED=6]="AUTH_REQUESTED",t[t.AUTHENTICATING=7]="AUTHENTICATING",t[t.AUTHENTICATED=8]="AUTHENTICATED",t))(_||{}),C=class t extends n.EventEmitter{url;scores;connectivity;subs;publisher;authPolicy;lowestValidationRatio;targetValidationRatio;validationRatioFn;validatedEventCount=0;nonValidatedEventCount=0;trusted=!1;complaining=!1;debug;static defaultValidationRatioUpdateFn=(t,e,i)=>{if(void 0===t.lowestValidationRatio||void 0===t.targetValidationRatio)return 1;let s=t.validationRatio;return(t.validationRatio>t.targetValidationRatio&&(s=Math.max(t.lowestValidationRatio,t.validationRatio-e/100)),s<t.validationRatio)?s:t.validationRatio};constructor(e,i,s){super(),this.url=m(e),this.scores=new Map,this.debug=r(`ndk:relay:${e}`),this.connectivity=new E(this,s),this.connectivity.netDebug=s?.netDebug,this.req=this.connectivity.req.bind(this.connectivity),this.close=this.connectivity.close.bind(this.connectivity),this.subs=new A(this,s.subManager),this.publisher=new T(this),this.authPolicy=i,this.targetValidationRatio=s?.initialValidationRatio,this.lowestValidationRatio=s?.lowestValidationRatio,this.validationRatioFn=(s?.validationRatioFn??t.defaultValidationRatioUpdateFn).bind(this),this.updateValidationRatio(),s||console.trace("relay created without ndk")}updateValidationRatio(){setTimeout(()=>{this.updateValidationRatio()},3e4)}get status(){return this.connectivity.status}get connectionStats(){return this.connectivity.connectionStats}async connect(t,e=!0){return this.connectivity.connect(t,e)}disconnect(){1!==this.status&&this.connectivity.disconnect()}subscribe(t,e){this.subs.addSubscription(t,e)}async publish(t,e=2500){return this.publisher.publish(t,e)}referenceTags(){return[["r",this.url]]}addValidatedEvent(){this.validatedEventCount++}addNonValidatedEvent(){this.nonValidatedEventCount++}get validationRatio(){return 0===this.nonValidatedEventCount?1:this.validatedEventCount/(this.validatedEventCount+this.nonValidatedEventCount)}shouldValidateEvent(){return!this.trusted&&(void 0===this.targetValidationRatio||this.validationRatio<this.targetValidationRatio)}get connected(){return this.connectivity.connected}req;close},N=class extends Error{errors;publishedToRelays;intendedRelaySet;constructor(t,e,i,s){super(t),this.errors=e,this.publishedToRelays=i,this.intendedRelaySet=s}get relayErrors(){let t=[];for(let[e,i]of this.errors)t.push(`${e.url}: ${i}`);return t.join("\n")}},P=class t{relays;debug;ndk;pool;constructor(t,e,i){this.relays=t,this.ndk=e,this.pool=i??e.pool,this.debug=e.debug.extend("relayset")}addRelay(t){this.relays.add(t)}get relayUrls(){return Array.from(this.relays).map(t=>t.url)}static fromRelayUrls(e,i,s=!0,n){if(!(n=n??i.pool))throw Error("No pool provided");let r=new Set;for(let t of e){let a=n.relays.get(m(t));if(a)a.status<5&&s&&a.connect(),r.add(a);else{let s=new C(m(t),i?.relayAuthDefaultPolicy,i);n.useTemporaryRelay(s,void 0,"requested from fromRelayUrls "+e),r.add(s)}}return new t(new Set(r),i,n)}async publish(t,e,i=1){let s=new Set,n=new Map,r=t.isEphemeral();t.publishStatus="pending";let a=Array.from(this.relays).map(i=>new Promise(a=>{i.publish(t,e).then(t=>{s.add(i),a()}).catch(t=>{r||n.set(i,t),a()})}));if(await Promise.all(a),s.size<i){if(!r){let e=new N("Not enough relays received the event",n,s,this);throw t.publishStatus="error",t.publishError=e,this.ndk.emit("event:publish-failed",t,e,this.relayUrls),e}}else t.emit("published",{relaySet:this,publishedToRelays:s});return s}get size(){return this.relays.size}},M=r("ndk:outbox:calculate");async function x(t,e){let i=new Set,s=await g(t,e.pubkey);s&&s.forEach(e=>{let s=t.pool?.getRelay(e);s&&i.add(s)});let n=e.tags.filter(t=>["a","e"].includes(t[0])).map(t=>t[2]).filter(t=>t&&t.startsWith("wss://")).filter(t=>{try{return new URL(t),!0}catch{return!1}}).map(t=>m(t));(n=Array.from(new Set(n)).slice(0,5)).forEach(e=>{let s=t.pool?.getRelay(e,!0,!0);s&&(M("Adding relay hint %s",e),i.add(s))});let r=e.getMatchingTags("p").map(t=>t[1]);return r.length<5?Array.from(f(t,r,"read",{preferredRelays:new Set(s)}).keys()).forEach(e=>{let s=t.pool?.getRelay(e,!1,!0);s&&(M("Adding p-tagged relay %s",e),i.add(s))}):M("Too many p-tags to consider %d",r.length),t.pool?.permanentAndConnectedRelays().forEach(t=>i.add(t)),new P(i,t)}function I(t,e,i){return function(t,e,i){let s=new Map,n=new Set;if(e.forEach(t=>{t.authors&&t.authors.forEach(t=>n.add(t))}),n.size>0){let i=function(t,e,i=2){return f(t,e,"write",{count:i})}(t,Array.from(n));for(let t of i.keys())s.set(t,[]);for(let t of e)if(t.authors)for(let[e,n]of i.entries()){let i=t.authors.filter(t=>n.includes(t));s.set(e,[...s.get(e),{...t,authors:i}])}else for(let e of i.keys())s.set(e,[...s.get(e),t])}else t.explicitRelayUrls&&t.explicitRelayUrls.forEach(t=>{s.set(t,e)});return 0===s.size&&i.permanentAndConnectedRelays().slice(0,5).forEach(t=>{s.set(t.url,e)}),s}(t,e,i)}function D(t,e){let i=new Map,s=t=>t.join(","),n=(t,e)=>t.every((t,i)=>t===e[i]);return t.concat(e).forEach(t=>{for(let[e,s]of i)if(n(s,t)||n(t,s)){t.length>=s.length&&i.set(e,t);return}i.set(s(t),t)}),Array.from(i.values())}var U=/(?<=\s|^)(#[^\s!@#$%^&*()=+./,[{\]};:'"?><]+)/g;async function V(t,e=[]){let i=[],s=t=>{e.find(e=>["q",t[0]].includes(e[0])&&e[1]===t[1])||e.push(t)};t=t.replace(/(@|nostr:)(npub|nprofile|note|nevent|naddr)[a-zA-Z0-9]+/g,t=>{try{let e;let n=t.split(/(@|nostr:)/)[2],{type:r,data:o}=a.Qe.decode(n);switch(r){case"npub":e=["p",o];break;case"nprofile":e=["p",o.pubkey];break;case"note":i.push(new Promise(async t=>{s(["q",o,await O(n)]),t()}));break;case"nevent":i.push(new Promise(async t=>{let{id:e,author:i}=o,{relays:r}=o;r&&0!==r.length||(r=[await O(n)]),s(["q",e,r[0]]),i&&s(["p",i]),t()}));break;case"naddr":i.push(new Promise(async t=>{let e=[o.kind,o.pubkey,o.identifier].join(":"),i=o.relays??[];0===i.length&&(i=[await O(n)]),s(["q",e,i[0]]),s(["p",o.pubkey]),t()}));break;default:return t}return e&&s(e),`nostr:${n}`}catch(e){return t}}),await Promise.all(i);let n=(function(t){let e=t.match(U),i=new Set,s=new Set;if(e)for(let t of e)i.has(t.slice(1))||(s.add(t.slice(1)),i.add(t.slice(1)));return Array.from(s)})(t).map(t=>["t",t]);return{content:t,tags:e=D(e,n)}}async function O(t){return""}function F(){if(void 0===this.kind)throw Error("Kind not set");return[0,3].includes(this.kind)||this.kind>=1e4&&this.kind<2e4||this.kind>=3e4&&this.kind<4e4}function L(){if(void 0===this.kind)throw Error("Kind not set");return this.kind>=2e4&&this.kind<3e4}function $(){if(void 0===this.kind)throw Error("Kind not set");return this.kind>=3e4&&this.kind<4e4}async function z(t,e,i="nip44"){let s;if(!this.ndk)throw Error("No NDK instance found!");if(e||(this.ndk.assertSigner(),e=this.ndk.signer),!t){let e=this.getMatchingTags("p");if(1!==e.length)throw Error("No recipient could be determined and no explicit recipient was provided");t=this.ndk.getUser({pubkey:e[0][1]})}if("nip44"===i&&await G(e,"nip44")&&(s=await e?.encrypt(t,this.content,"nip44")),(!s||"nip04"===i)&&await G(e,"nip04")&&(s=await e.encrypt(t,this.content,"nip04")),!s)throw Error("Failed to encrypt event.");this.content=s}async function q(t,e,i){let s;if(!this.ndk)throw Error("No NDK instance found!");if(e||(this.ndk.assertSigner(),e=this.ndk.signer),!e)throw Error("no NDK signer");if(t||(t=this.author),i||(i=this.content.match(/\\?iv=/)?"nip04":"nip44"),("nip04"===i||4===this.kind)&&await G(e,"nip04")&&this.content.search("\\?iv=")&&(s=await e.decrypt(t,this.content,"nip04")),!s&&"nip44"===i&&await G(e,"nip44")&&(s=await e.decrypt(t,this.content,"nip44")),!s)throw Error("Failed to decrypt event.");this.content=s}async function G(t,e){return!!t.encryptionEnabled&&(!e||!!await t.encryptionEnabled(e))}function W(t=2){let e=[];return(this.onRelays.length>0?e=this.onRelays.map(t=>t.url):this.relay&&(e=[this.relay.url]),e.length>t&&(e=e.slice(0,t)),this.isParamReplaceable())?a.Qe.naddrEncode({kind:this.kind,pubkey:this.pubkey,identifier:this.replaceableDTag(),relays:e}):e.length>0?a.Qe.neventEncode({id:this.tagId(),relays:e,author:this.pubkey}):a.Qe.noteEncode(this.tagId())}async function H(t=!0,e){var i;if(!e&&t){if(!this.ndk)throw Error("No NDK instance found");this.ndk.assertSigner(),e=this.ndk.signer}let s=new to(this.ndk,{kind:(i=this,1===i.kind?6:16)});return this.isProtected||(s.content=JSON.stringify(this.rawEvent())),s.tag(this),1!==this.kind&&s.tags.push(["k",`${this.kind}`]),e&&await s.sign(e),t&&await s.publish(),s}var K=new Set(["A","E","I"]),j=new Set(["a","e","i"]);function Q(t){return"E"===t[0]||"root"===t[3]}async function B(t,e){let i;if(!this.ndk)throw Error("NDK instance not found");let s=this.getMatchingTags(t,e);if(0===s.length)return;let[n,r,a]=s[0];return await this.ndk.fetchEvent(r,{},i)}async function J(t){if(!this.ndk)throw Error("NDK instance not found");let e=function(t,e){e??=t.tagType();let i=t.tags.find(Q);if(!i){if(function(t){for(let e of t.tags)if("e"===e[0]&&(e[3]??"").length>0)return!0;return!1}(t))return;let i=t.getMatchingTags(e);if(i.length<3)return i[0]}return i}(this);if(e)return this.ndk.fetchEventFromTag(e,this,t)}async function Y(t){if(!this.ndk)throw Error("NDK instance not found");let e=function(t,e){let i;if(1111===t.kind){let e;for(let i of t.tags)if(K.has(i[0]))e=i;else if(j.has(i[0])){e=i;break}return e}e??=t.tagType();let s=!1;for(let n of t.tags)if(n[0]===e){if((n[3]??"").length>0&&(s=!0),s&&"reply"===n[3])return n;s&&"root"===n[3]&&(i=n),s||(i=n)}return i}(this);if(e)return this.ndk.fetchEventFromTag(e,this,t)}function Z(t=!1,e=!1){let i=[0,this.pubkey,this.created_at,this.kind,this.tags,this.content];return t&&i.push(this.sig),e&&i.push(this.id),JSON.stringify(i)}var X={};async function tt(t,e){return new Promise(e=>{let i=t.serialize(),n=!1;X[t.id]||(X[t.id]={event:t,resolves:[]},n=!0),X[t.id].resolves.push(e),n&&s.postMessage({serialized:i,id:t.id,sig:t.sig,pubkey:t.pubkey})})}var te=/^[a-f0-9]{64}$/;function ti(){if("number"!=typeof this.kind||"string"!=typeof this.content||"number"!=typeof this.created_at||"string"!=typeof this.pubkey||!this.pubkey.match(te)||!Array.isArray(this.tags))return!1;for(let t=0;t<this.tags.length;t++){let e=this.tags[t];if(!Array.isArray(e))return!1;for(let t=0;t<e.length;t++)if("object"==typeof e[t])return!1}return!0}var ts=new u.LRUCache({maxSize:1e3,entryExpirationTimeInMS:6e4});function tn(t){if("boolean"==typeof this.signatureVerified)return this.signatureVerified;let e=ts.get(this.id);if(null!==e)return this.signatureVerified=!!e;try{if(this.ndk?.asyncSigVerification)tt(this,t).then(e=>{t&&(this.signatureVerified=e,e&&ts.set(this.id,this.sig)),e||(this.ndk.emit("event:invalid-sig",this),ts.set(this.id,!1))});else{let t=(0,o.sc)(new TextEncoder().encode(this.serialize())),e=l.ko.verify(this.sig,t,this.pubkey);return e?ts.set(this.id,this.sig):ts.set(this.id,!1),this.signatureVerified=e}}catch(t){return this.signatureVerified=!1}}function tr(){return function(t){let e=(0,o.sc)(new TextEncoder().encode(t));return(0,h.My)(e)}(this.serialize())}var ta=new Set([0,4,1059,13,3,9734,5]),to=class t extends n.EventEmitter{ndk;created_at;content="";tags=[];kind;id="";sig;pubkey="";signatureVerified;_author=void 0;relay;get onRelays(){let t=[];return this.ndk?t=this.ndk.subManager.seenEvents.get(this.id)||[]:this.relay&&t.push(this.relay),t}publishStatus="success";publishError;constructor(e,i){super(),this.ndk=e,this.created_at=i?.created_at,this.content=i?.content||"",this.tags=i?.tags||[],this.id=i?.id||"",this.sig=i?.sig,this.pubkey=i?.pubkey||"",this.kind=i?.kind,i instanceof t&&(this.relay&&(this.relay=i.relay,this.ndk?.subManager.seenEvent(i.id,this.relay)),this.publishStatus=i.publishStatus,this.publishError=i.publishError)}static deserialize(e,i){return new t(e,function(t){let e=JSON.parse(t),i={pubkey:e[1],created_at:e[2],kind:e[3],tags:e[4],content:e[5]};return e.length>=7&&(i.sig=e[6]),e.length>=8&&(i.id=e[7]),i}(i))}rawEvent(){return{created_at:this.created_at,content:this.content,tags:this.tags,kind:this.kind,pubkey:this.pubkey,id:this.id,sig:this.sig}}set author(t){this.pubkey=t.pubkey,this._author=t,this._author.ndk??=this.ndk}get author(){if(this._author)return this._author;if(!this.ndk)throw Error("No NDK instance found");let t=this.ndk.getUser({pubkey:this.pubkey});return this._author=t,t}tagExternal(t,e,i){let s=["i"],n=["k"];switch(e){case"url":let r=new URL(t);r.hash="",s.push(r.toString()),n.push(`${r.protocol}//${r.host}`);break;case"hashtag":s.push(`#${t.toLowerCase()}`),n.push("#");break;case"geohash":s.push(`geo:${t.toLowerCase()}`),n.push("geo");break;case"isbn":s.push(`isbn:${t.replace(/-/g,"")}`),n.push("isbn");break;case"podcast:guid":s.push(`podcast:guid:${t}`),n.push("podcast:guid");break;case"podcast:item:guid":s.push(`podcast:item:guid:${t}`),n.push("podcast:item:guid");break;case"podcast:publisher:guid":s.push(`podcast:publisher:guid:${t}`),n.push("podcast:publisher:guid");break;case"isan":s.push(`isan:${t.split("-").slice(0,4).join("-")}`),n.push("isan");break;case"doi":s.push(`doi:${t.toLowerCase()}`),n.push("doi");break;default:throw Error(`Unsupported NIP-73 entity type: ${e}`)}i&&s.push(i),this.tags.push(s),this.tags.push(n)}tag(e,i,s,n){let r=[];if(void 0!==e.fetchProfile){let t=[n??="p",e.pubkey];i&&t.push("",i),r.push(t)}else if(e instanceof t)for(let t of(s??=e?.pubkey===this.pubkey,r=e.referenceTags(i,s,n),e.getMatchingTags("p")))t[1]!==this.pubkey&&(this.tags.find(e=>"p"===e[0]&&e[1]===t[1])||this.tags.push(["p",t[1]]));else if(Array.isArray(e))r=[e];else throw Error("Invalid argument",e);this.tags=D(this.tags,r)}async toNostrEvent(t){if(!t&&""===this.pubkey){let t=await this.ndk?.signer?.user();this.pubkey=t?.pubkey||""}this.created_at||(this.created_at=Math.floor(Date.now()/1e3));let{content:e,tags:i}=await this.generateTags();this.content=e||"",this.tags=i;try{this.id=this.getEventHash()}catch(t){}return this.rawEvent()}serialize=Z.bind(this);getEventHash=tr.bind(this);validate=ti.bind(this);verifySignature=tn.bind(this);isReplaceable=F.bind(this);isEphemeral=L.bind(this);isDvm=()=>this.kind&&this.kind>=5e3&&this.kind<=7e3;isParamReplaceable=$.bind(this);encode=W.bind(this);encrypt=z.bind(this);decrypt=q.bind(this);getMatchingTags(t,e){let i=this.tags.filter(e=>e[0]===t);return void 0===e?i:i.filter(t=>t[3]===e)}hasTag(t,e){return this.tags.some(i=>i[0]===t&&(!e||i[3]===e))}tagValue(t){let e=this.getMatchingTags(t);if(0!==e.length)return e[0][1]}get alt(){return this.tagValue("alt")}set alt(t){this.removeTag("alt"),t&&this.tags.push(["alt",t])}get dTag(){return this.tagValue("d")}set dTag(t){this.removeTag("d"),t&&this.tags.push(["d",t])}removeTag(t){let e=Array.isArray(t)?t:[t];this.tags=this.tags.filter(t=>!e.includes(t[0]))}async sign(t){t?this.author=await t.user():(this.ndk?.assertSigner(),t=this.ndk.signer);let e=await this.toNostrEvent();return this.sig=await t.sign(e),this.sig}async publishReplaceable(t,e,i){return this.id="",this.created_at=Math.floor(Date.now()/1e3),this.sig="",this.publish(t,e,i)}async publish(t,e,i){var s;if(this.sig||await this.sign(),!this.ndk)throw Error("NDKEvent must be associated with an NDK instance to publish");if(t||(t=this.ndk.devWriteRelaySet||await x(this.ndk,this)),5===this.kind&&this.ndk.cacheAdapter?.deleteEventIds){let t=this.getMatchingTags("e").map(t=>t[1]);this.ndk.cacheAdapter.deleteEventIds(t)}let n=this.rawEvent();if(this.ndk.cacheAdapter?.addUnpublishedEvent&&(s=this,!th.has(s.kind)))try{this.ndk.cacheAdapter.addUnpublishedEvent(this,t.relayUrls)}catch(t){console.error("Error adding unpublished event to cache",t)}5===this.kind&&this.ndk.cacheAdapter?.deleteEventIds&&this.ndk.cacheAdapter.deleteEventIds(this.getMatchingTags("e").map(t=>t[1])),this.ndk.subManager.dispatchEvent(n,void 0,!0);let r=await t.publish(this,e,i);return r.forEach(t=>this.ndk?.subManager.seenEvent(this.id,t)),r}async generateTags(){let t=[],e=await V(this.content,this.tags),i=e.content;if(t=e.tags,this.kind&&this.isParamReplaceable()&&!this.getMatchingTags("d")[0]){let e=this.tagValue("title"),i=[...Array(e?6:16)].map(()=>Math.random().toString(36)[2]).join("");e&&e.length>0&&(i=e.replace(/[^a-z0-9]+/gi,"-").replace(/^-|-$/g,"")+"-"+i),t.push(["d",i])}if(this.shouldAddClientTag){let e=["client",this.ndk.clientName??""];this.ndk.clientNip89&&e.push(this.ndk.clientNip89),t.push(e)}else this.shouldStripClientTag&&(t=t.filter(t=>"client"!==t[0]));return{content:i||"",tags:t}}get shouldAddClientTag(){return!(!this.ndk?.clientName&&!this.ndk?.clientNip89||ta.has(this.kind)||this.isEphemeral()||this.isReplaceable()||this.isDvm()||this.hasTag("client"))}get shouldStripClientTag(){return ta.has(this.kind)}muted(){let t=this.ndk?.mutedIds.get(this.pubkey);if(t&&"p"===t)return"author";let e=this.tagReference(),i=this.ndk?.mutedIds.get(e[1]);return i&&i===e[0]?"event":null}replaceableDTag(){if(this.kind&&this.kind>=3e4&&this.kind<=4e4){let t=this.getMatchingTags("d")[0];return t?t[1]:""}throw Error("Event is not a parameterized replaceable event")}deduplicationKey(){return 0===this.kind||3===this.kind||this.kind&&this.kind>=1e4&&this.kind<2e4?`${this.kind}:${this.pubkey}`:this.tagId()}tagId(){return this.isParamReplaceable()?this.tagAddress():this.id}tagAddress(){if(this.isParamReplaceable()){let t=this.dTag??"";return`${this.kind}:${this.pubkey}:${t}`}if(this.isReplaceable())return`${this.kind}:${this.pubkey}:`;throw Error("Event is not a replaceable event")}tagType(){return this.isParamReplaceable()?"a":"e"}tagReference(t){let e;return e=this.isParamReplaceable()?["a",this.tagAddress()]:["e",this.tagId()],this.relay?e.push(this.relay.url):e.push(""),e.push(t??""),this.isParamReplaceable()||e.push(this.pubkey),e}referenceTags(t,e,i){let s=[];return(s=(s=this.isParamReplaceable()?[[i??"a",this.tagAddress()],[i??"e",this.id]]:[[i??"e",this.id]]).map(e=>("e"===e[0]||t?e.push(this.relay?.url??""):this.relay?.url&&e.push(this.relay?.url),e))).forEach(e=>{"e"===e[0]?(e.push(t??""),e.push(this.pubkey)):t&&e.push(t)}),s=[...s,...this.getMatchingTags("h")],e||s.push(...this.author.referenceTags()),s}filter(){return this.isParamReplaceable()?{"#a":[this.tagId()]}:{"#e":[this.tagId()]}}nip22Filter(){return this.isParamReplaceable()?{"#A":[this.tagId()]}:{"#E":[this.tagId()]}}async delete(e,i=!0){if(!this.ndk)throw Error("No NDK instance found");this.ndk.assertSigner();let s=new t(this.ndk,{kind:5,content:e||""});return s.tag(this,void 0,!0),s.tags.push(["k",this.kind.toString()]),i&&(this.emit("deleted"),await s.publish()),s}set isProtected(t){this.removeTag("-"),t&&this.tags.push(["-"])}get isProtected(){return this.hasTag("-")}fetchTaggedEvent=B.bind(this);fetchRootEvent=J.bind(this);fetchReplyEvent=Y.bind(this);repost=H.bind(this);async react(e,i=!0){if(!this.ndk)throw Error("No NDK instance found");this.ndk.assertSigner();let s=new t(this.ndk,{kind:7,content:e});return s.tag(this),i&&await s.publish(),s}get isValid(){return this.validate()}reply(){let e=new t(this.ndk);if(1===this.kind)e.kind=1,this.hasTag("e")?e.tags=[...e.tags,...this.getMatchingTags("e"),...this.getMatchingTags("p"),...this.getMatchingTags("a"),...this.referenceTags("reply")]:e.tag(this,"root");else{e.kind=1111;let t=["A","E","I","P"],i=this.tags.filter(e=>t.includes(e[0]));if(i.length>0){let t=this.tagValue("K");e.tags.push(...i),t&&e.tags.push(["K",t]);let[s,n,r,...a]=this.tagReference(),o=[s,n,...a];e.tags.push(o)}else{let[t,i,s,n]=this.tagReference(),r=[t,i,n??""];"e"===t&&r.push(this.pubkey),e.tags.push(r);let a=[...r];a[0]=a[0].toUpperCase(),e.tags.push(a),e.tags.push(["K",this.kind.toString()]),e.tags.push(["P",this.pubkey])}e.tags.push(["k",this.kind.toString()]),e.tags.push(...this.getMatchingTags("p")),e.tags.push(["p",this.pubkey])}return e}},th=new Set([24133,13194,23194,23195]),tl=class extends n.EventEmitter{_relays=new Map;status="idle";autoConnectRelays=new Set;poolBlacklistRelayUrls=new Set;debug;temporaryRelayTimers=new Map;flappingRelays=new Set;backoffTimes=new Map;ndk;get blacklistRelayUrls(){let t=new Set(this.ndk.blacklistRelayUrls);return this.poolBlacklistRelayUrls.forEach(e=>t.add(e)),t}constructor(t=[],e=[],i,{debug:s,name:n}={}){super(),this.debug=s??i.debug.extend("pool"),n&&(this._name=n),this.ndk=i,this.relayUrls=t,this.poolBlacklistRelayUrls=new Set(e),this.ndk.pools.push(this)}get relays(){return this._relays}set relayUrls(t){for(let e of(this._relays.clear(),t)){let t=new C(e,void 0,this.ndk);t.connectivity.netDebug=this.ndk.netDebug,this.addRelay(t)}}_name="unnamed";get name(){return this._name}set name(t){this._name=t,this.debug=this.debug.extend(t)}useTemporaryRelay(t,e=3e4,i){let s=this.relays.has(t.url);s||(this.addRelay(t),this.debug("Adding temporary relay %s for filters %o",t.url,i));let n=this.temporaryRelayTimers.get(t.url);if(n&&clearTimeout(n),!s||n){let i=setTimeout(()=>{this.ndk.explicitRelayUrls?.includes(t.url)||this.removeRelay(t.url)},e);this.temporaryRelayTimers.set(t.url,i)}}addRelay(t,e=!0){let i=this.relays.has(t.url),s=this.blacklistRelayUrls?.has(t.url),n=t.url.includes("/npub1"),r=!0,a=t.url;if(i)return;if(s){this.debug(`Refusing to add relay ${a}: blacklisted`);return}if(n){this.debug(`Refusing to add relay ${a}: is a filter relay`);return}if(this.ndk.cacheAdapter?.getRelayStatus){let i=this.ndk.cacheAdapter.getRelayStatus(a);if(i&&i.dontConnectBefore){if(i.dontConnectBefore>Date.now()){let s=i.dontConnectBefore-Date.now();this.debug(`Refusing to add relay ${a}: delayed connect for ${s}ms`),setTimeout(()=>{this.addRelay(t,e)},s);return}r=!1}}let o=e=>this.emit("notice",t,e),h=()=>this.handleRelayConnect(a),l=()=>this.handleRelayReady(t),u=()=>this.emit("relay:disconnect",t),c=()=>this.handleFlapping(t),d=e=>this.emit("relay:auth",t,e),p=()=>this.emit("relay:authed",t);t.off("notice",o),t.off("connect",h),t.off("ready",l),t.off("disconnect",u),t.off("flapping",c),t.off("auth",d),t.off("authed",p),t.on("notice",o),t.on("connect",h),t.on("ready",l),t.on("disconnect",u),t.on("flapping",c),t.on("auth",d),t.on("authed",p),t.on("delayed-connect",e=>{this.ndk.cacheAdapter?.updateRelayStatus&&this.ndk.cacheAdapter.updateRelayStatus(t.url,{dontConnectBefore:Date.now()+e})}),this._relays.set(a,t),e&&this.autoConnectRelays.add(a),e&&"active"===this.status&&(this.emit("relay:connecting",t),t.connect(void 0,r).catch(t=>{this.debug(`Failed to connect to relay ${a}`,t)}))}removeRelay(t){let e=this.relays.get(t);if(e)return e.disconnect(),this.relays.delete(t),this.autoConnectRelays.delete(t),this.emit("relay:disconnect",e),!0;let i=this.temporaryRelayTimers.get(t);return i&&(clearTimeout(i),this.temporaryRelayTimers.delete(t)),!1}isRelayConnected(t){let e=m(t),i=this.relays.get(e);return!!i&&5===i.status}getRelay(t,e=!0,i=!1,s){let n=this.relays.get(m(t));return n||((n=new C(t,void 0,this.ndk)).connectivity.netDebug=this.ndk.netDebug,i?this.useTemporaryRelay(n,3e4,s):this.addRelay(n,e)),n}handleRelayConnect(t){let e=this.relays.get(t);if(!e){console.error("NDK BUG: relay not found in pool",{relayUrl:t});return}this.emit("relay:connect",e),this.stats().connected===this.relays.size&&this.emit("connect")}handleRelayReady(t){this.emit("relay:ready",t)}async connect(t){let e=[];for(let i of(this.status="active",this.debug(`Connecting to ${this.relays.size} relays${t?`, timeout ${t}...`:""}`),new Set(this.autoConnectRelays.keys()))){let s=this.relays.get(i);if(!s){console.log(`Relay ${i} not found in pool ${this.name}`);continue}let n=new Promise((e,i)=>(this.emit("relay:connecting",s),s.connect(t).then(e).catch(i)));if(t){let i=new Promise((e,i)=>{setTimeout(()=>i(`Timed out after ${t}ms`),t)});e.push(Promise.race([n,i]).catch(t=>{this.debug(`Failed to connect to relay ${s.url}: ${t??"No reason specified"}`)}))}else e.push(n)}let i=()=>{let t=this.stats().connected===this.relays.size,e=this.stats().connected>0;!t&&e&&this.emit("connect")};t&&setTimeout(i,t),await Promise.all(e),i()}checkOnFlappingRelays(){if(this.flappingRelays.size/this.relays.size>=.8)for(let t of this.flappingRelays)this.backoffTimes.set(t,0)}handleFlapping(t){this.debug(`Relay ${t.url} is flapping`);let e=this.backoffTimes.get(t.url)||5e3;e*=2,this.backoffTimes.set(t.url,e),this.debug(`Backoff time for ${t.url} is ${e}ms`),setTimeout(()=>{this.debug(`Attempting to reconnect to ${t.url}`),this.emit("relay:connecting",t),t.connect(),this.checkOnFlappingRelays()},e),t.disconnect(),this.emit("flapping",t)}size(){return this.relays.size}stats(){let t={total:0,connected:0,disconnected:0,connecting:0};for(let e of this.relays.values())t.total++,5===e.status?t.connected++:1===e.status?t.disconnected++:4===e.status&&t.connecting++;return t}connectedRelays(){return Array.from(this.relays.values()).filter(t=>t.status>=5)}permanentAndConnectedRelays(){return Array.from(this.relays.values()).filter(t=>t.status>=5&&!this.temporaryRelayTimers.has(t.url))}urls(){return Array.from(this.relays.keys())}};function tu(t){return!!(t.filter.ids&&function(t){let e=t.filter.ids;return!!e&&e.length===t.eventFirstSeen.size}(t))}function tc(t){let e;if(t.match(td)){let[e,i,s]=t.split(":"),n={authors:[i],kinds:[parseInt(e)]};return s&&(n["#d"]=[s]),n}if(t.match(tp))try{switch((e=a.Qe.decode(t)).type){case"nevent":{let t={ids:[e.data.id]};return e.data.author&&(t.authors=[e.data.author]),e.data.kind&&(t.kinds=[e.data.kind]),t}case"note":return{ids:[e.data]};case"naddr":let i={authors:[e.data.pubkey],kinds:[e.data.kind]};return e.data.identifier&&(i["#d"]=[e.data.identifier]),i}}catch(e){console.error("Error decoding",t,e)}return{ids:[t]}}var td=/^(\d+):([0-9A-Fa-f]+)(?::(.*))?$/,tp=/^n(event|ote|profile|pub|addr)1[\d\w]+$/,tg=class t extends to{static kind=30023;static kinds=[30023];constructor(t,e){super(t,e),this.kind??=30023}static from(e){return new t(e.ndk,e)}get title(){return this.tagValue("title")}set title(t){this.removeTag("title"),t&&this.tags.push(["title",t])}get image(){return this.tagValue("image")}set image(t){this.removeTag("image"),t&&this.tags.push(["image",t])}get summary(){return this.tagValue("summary")}set summary(t){this.removeTag("summary"),t&&this.tags.push(["summary",t])}get published_at(){let t=this.tagValue("published_at");if(t){let e=parseInt(t);return e>1e12&&(e=Math.floor(e/1e3)),e}}set published_at(t){this.removeTag("published_at"),void 0!==t&&this.tags.push(["published_at",t.toString()])}async generateTags(){return super.generateTags(),this.published_at||(this.published_at=this.created_at),super.generateTags()}get url(){return this.tagValue("url")}set url(t){t?this.tags.push(["url",t]):this.removeTag("url")}},tf=class t extends to{_proofs=[];_mint;static kind=7375;static kinds=[7375];_deletes=[];original;constructor(t,e){super(t,e),this.kind??=7375}static async from(e){let i=new t(e.ndk,e);i.original=e;try{await i.decrypt()}catch{i.content=i.original.content}try{let t=JSON.parse(i.content);if(i.proofs=t.proofs,i.mint=t.mint??i.tagValue("mint"),i.deletedTokens=t.del??[],!Array.isArray(i.proofs))return}catch(t){return}return i}get proofs(){return this._proofs}set proofs(t){let e=new Set;this._proofs=t.filter(t=>e.has(t.C)?(console.warn("Passed in proofs had duplicates, ignoring",t.C),!1):t.amount<0?(console.warn("Invalid proof with negative amount",t),!1):(e.add(t.C),!0)).map(this.cleanProof)}cleanProof(t){return{id:t.id,amount:t.amount,C:t.C,secret:t.secret}}async toNostrEvent(t){let e={proofs:this.proofs.map(this.cleanProof),mint:this.mint,del:this.deletedTokens??[]};this.content=JSON.stringify(e);let i=await this.ndk.signer.user();return await this.encrypt(i,void 0,"nip44"),super.toNostrEvent(t)}set mint(t){this._mint=t}get mint(){return this._mint}get deletedTokens(){return this._deletes}set deletedTokens(t){this._deletes=t}get amount(){return this.proofs.reduce((t,e)=>{if(e.amount<0)throw Error("proof amount is negative");return t+e.amount},0)}async publish(t,e,i){return this.original?this.original.publish(t,e,i):super.publish(t,e,i)}},ty=class t extends to{_article;static kind=9802;static kinds=[9802];constructor(t,e){super(t,e),this.kind??=9802}static from(e){return new t(e.ndk,e)}get url(){return this.tagValue("r")}set context(t){void 0===t?this.tags=this.tags.filter(([t,e])=>"context"!==t):(this.tags=this.tags.filter(([t,e])=>"context"!==t),this.tags.push(["context",t]))}get context(){return this.tags.find(([t,e])=>"context"===t)?.[1]??void 0}get article(){return this._article}set article(t){this._article=t,"string"==typeof t?this.tags.push(["r",t]):this.tag(t)}getArticleTag(){return this.getMatchingTags("a")[0]||this.getMatchingTags("e")[0]||this.getMatchingTags("r")[0]}async getArticle(){let t;if(void 0!==this._article)return this._article;let e=this.getArticleTag();if(e){switch(e[0]){case"a":let[i,s,n]=e[1].split(":");t=a.Qe.naddrEncode({kind:parseInt(i),pubkey:s,identifier:n});break;case"e":t=a.Qe.noteEncode(e[1]);break;case"r":this._article=e[1]}if(t){let e=await this.ndk?.fetchEvent(t);e&&(30023===e.kind&&(e=tg.from(e)),this._article=e)}return this._article}}};function tm(t){let e={};if(2===t.length){let i=t[1].split(" ");for(let t=0;t<i.length;t+=2){let s=i[t],n=i[t+1];"fallback"===s?(e.fallback||(e.fallback=[]),e.fallback.push(n)):e[s]=n}}for(let i of t){let t=i.split(" "),s=t[0],n=t.slice(1).join(" ");"fallback"===s?(e.fallback||(e.fallback=[]),e.fallback.push(n)):e[s]=n}return e}function tb(t){let e=["imeta"];for(let[i,s]of Object.entries(t))if(Array.isArray(s))for(let t of s)e.push(i,t);else s&&e.push(i,s);return e}var tk=class t extends to{static kind=20;static kinds=[20];_imetas;constructor(t,e){super(t,e),this.kind??=20}static from(e){return new t(e.ndk,e.rawEvent())}get isValid(){return this.imetas.length>0}get imetas(){return this._imetas||(this._imetas=this.tags.filter(t=>"imeta"===t[0]).map(tm).filter(t=>!!t.url)),this._imetas}set imetas(t){this._imetas=t,this.tags=this.tags.filter(t=>"imeta"!==t[0]),this.tags.push(...t.map(tb))}},tw=class t extends to{_encryptedTags;static kinds=[10063,30001,10004,10050,10030,10015,10001,10002,10007,10006,10003];encryptedTagsLength;constructor(t,e){super(t,e),this.kind??=30001}static from(e){return new t(e.ndk,e)}get title(){let t=this.tagValue("title")||this.tagValue("name");if(t)return t;if(3===this.kind)return"Contacts";if(1e4===this.kind)return"Mute";if(10001===this.kind)return"Pinned Notes";if(10002===this.kind)return"Relay Metadata";if(10003===this.kind)return"Bookmarks";else if(10004===this.kind)return"Communities";else if(10005===this.kind)return"Public Chats";else if(10006===this.kind)return"Blocked Relays";else if(10007===this.kind)return"Search Relays";else if(10050===this.kind)return"Direct Message Receive Relays";else if(10015===this.kind)return"Interests";else if(10030===this.kind)return"Emojis";else return this.tagValue("d")}set title(t){this.removeTag(["title","name"]),t&&this.tags.push(["title",t])}get name(){return this.title}set name(t){this.title=t}get description(){return this.tagValue("description")}set description(t){this.removeTag("description"),t&&this.tags.push(["description",t])}get image(){return this.tagValue("image")}set image(t){this.removeTag("image"),t&&this.tags.push(["image",t])}isEncryptedTagsCacheValid(){return!!(this._encryptedTags&&this.encryptedTagsLength===this.content.length)}async encryptedTags(t=!0){if(t&&this.isEncryptedTagsCacheValid())return this._encryptedTags;if(!this.ndk)throw Error("NDK instance not set");if(!this.ndk.signer)throw Error("NDK signer not set");let e=await this.ndk.signer.user();try{if(this.content.length>0)try{let t=await this.ndk.signer.decrypt(e,this.content),i=JSON.parse(t);if(i&&i[0])return this.encryptedTagsLength=this.content.length,this._encryptedTags=i;return this.encryptedTagsLength=this.content.length,this._encryptedTags=[]}catch(t){console.log(`error decrypting ${this.content}`)}}catch(t){}return[]}validateTag(t){return!0}getItems(t){return this.tags.filter(e=>e[0]===t)}get items(){return this.tags.filter(t=>!["d","L","l","title","name","description","published_at","summary","image","thumb","alt","expiration","subject","client"].includes(t[0]))}async addItem(t,e,i=!1,s="bottom"){let n;if(!this.ndk)throw Error("NDK instance not set");if(!this.ndk.signer)throw Error("NDK signer not set");if(t instanceof to)n=[t.tagReference(e)];else if(t instanceof tO)n=t.referenceTags();else if(t instanceof C)n=t.referenceTags();else if(Array.isArray(t))n=[t];else throw Error("Invalid object type");if(e&&n[0].push(e),i){let t=await this.ndk.signer.user(),e=await this.encryptedTags();"top"===s?e.unshift(...n):e.push(...n),this._encryptedTags=e,this.encryptedTagsLength=this.content.length,this.content=JSON.stringify(e),await this.encrypt(t)}else"top"===s?this.tags.unshift(...n):this.tags.push(...n);this.created_at=Math.floor(Date.now()/1e3),this.emit("change")}async removeItemByValue(t,e=!0){if(!this.ndk)throw Error("NDK instance not set");if(!this.ndk.signer)throw Error("NDK signer not set");let i=this.tags.findIndex(e=>e[1]===t);i>=0&&this.tags.splice(i,1);let s=await this.ndk.signer.user(),n=await this.encryptedTags(),r=n.findIndex(e=>e[1]===t);if(r>=0&&(n.splice(r,1),this._encryptedTags=n,this.encryptedTagsLength=this.content.length,this.content=JSON.stringify(n),await this.encrypt(s)),e)return this.publishReplaceable();this.created_at=Math.floor(Date.now()/1e3),this.emit("change")}async removeItem(t,e){if(!this.ndk)throw Error("NDK instance not set");if(!this.ndk.signer)throw Error("NDK signer not set");if(e){let e=await this.ndk.signer.user(),i=await this.encryptedTags();i.splice(t,1),this._encryptedTags=i,this.encryptedTagsLength=this.content.length,this.content=JSON.stringify(i),await this.encrypt(e)}else this.tags.splice(t,1);return this.created_at=Math.floor(Date.now()/1e3),this.emit("change"),this}has(t){return this.items.some(e=>e[1]===t)}filterForItems(){let t=new Set,e=new Map,i=[];for(let i of this.items)if("e"===i[0]&&i[1])t.add(i[1]);else if("a"===i[0]&&i[1]){let[t,s,n]=i[1].split(":");if(!t||!s)continue;let r=`${t}:${s}`,a=e.get(r)||[];a.push(n||""),e.set(r,a)}if(t.size>0&&i.push({ids:Array.from(t)}),e.size>0)for(let[t,s]of e.entries()){let[e,n]=t.split(":");i.push({kinds:[parseInt(e)],authors:[n],"#d":s})}return i}},tv=class t extends to{debug;_proofs=[];static kind=9321;static kinds=[t.kind];constructor(t,e){super(t,e),this.kind??=9321,this.debug=t?.debug.extend("nutzap")??r("ndk:nutzap"),this.alt||(this.alt="This is a nutzap")}static from(t){let e=new this(t.ndk,t);try{let t=e.getMatchingTags("proof");t.length?e._proofs=t.map(t=>JSON.parse(t[1])):e._proofs=JSON.parse(e.content)}catch{return}if(e._proofs&&e._proofs.length)return e}set comment(t){this.content=t??""}get comment(){let t=this.tagValue("comment");return t||this.content}set proofs(t){for(let e of(this._proofs=t,this.tags=this.tags.filter(t=>"proof"!==t[0]),t))this.tags.push(["proof",JSON.stringify(e)])}get proofs(){return this._proofs}get p2pk(){let t=this.proofs[0];try{let e=JSON.parse(t.secret),i={};if("string"==typeof e?(i=JSON.parse(e),this.debug("stringified payload",t.secret)):"object"==typeof e&&(i=e),"P2PK"===i[0]&&i[1]?.data){let t=i[1].data.slice(2);if(t)return t}}catch(t){this.debug("error parsing p2pk pubkey",t,this.proofs[0])}}get mint(){return this.tagValue("u")}set mint(t){this.removeTag("u"),this.tag(["u",t])}get unit(){return this.tagValue("unit")??"sat"}set unit(t){this.removeTag("unit"),t&&this.tag(["unit",t])}get amount(){let t=this.proofs.reduce((t,e)=>t+e.amount,0);return"msat"===this.unit?1e3*t:t}sender=this.author;set target(t){this.tags=this.tags.filter(t=>"p"!==t[0]),t instanceof to&&this.tags.push(t.tagReference())}set recipientPubkey(t){this.removeTag("p"),this.tag(["p",t])}get recipientPubkey(){return this.tagValue("p")}get recipient(){let t=this.recipientPubkey;return this.ndk?this.ndk.getUser({pubkey:t}):new tO({pubkey:t})}async toNostrEvent(){"msat"===this.unit&&(this.unit="sat"),this.removeTag("amount"),this.tags.push(["amount",this.amount.toString()]);let t=await super.toNostrEvent();return t.content=this.comment,t}get isValid(){let t=0,e=0,i=0;for(let s of this.tags)"e"===s[0]&&t++,"p"===s[0]&&e++,"u"===s[0]&&i++;return 1===e&&1===i&&t<=1&&this.proofs.length>0}},tR=class t extends to{static kind=10019;static kinds=[10019];_p2pk;constructor(t,e){super(t,e),this.kind??=10019}static from(e){return new t(e.ndk,e)}set relays(t){for(let e of(this.tags=this.tags.filter(t=>"relay"!==t[0]),t))this.tags.push(["relay",e])}get relays(){let t=[];for(let e of this.tags)"relay"===e[0]&&t.push(e[1]);return t}set mints(t){for(let e of(this.tags=this.tags.filter(t=>"mint"!==t[0]),t))this.tags.push(["mint",e])}get mints(){let t=[];for(let e of this.tags)"mint"===e[0]&&t.push(e[1]);return Array.from(new Set(t))}get p2pk(){return this._p2pk||(this._p2pk=this.tagValue("pubkey")??this.pubkey),this._p2pk}set p2pk(t){this._p2pk=t,this.removeTag("pubkey"),t&&this.tags.push(["pubkey",t])}get relaySet(){return P.fromRelayUrls(this.relays,this.ndk)}},tE=class t extends to{relaySet;memberSet=new Set;static kind=39002;static kinds=[39002];constructor(t,e){super(t,e),this.kind??=39002,this.memberSet=new Set(this.members)}static from(e){return new t(e.ndk,e)}get members(){return this.getMatchingTags("p").map(t=>t[1])}hasMember(t){return this.memberSet.has(t)}async publish(t,e,i){return t??=this.relaySet,super.publishReplaceable(t,e,i)}},tT=class t extends to{static kind=39e3;static kinds=[39e3];constructor(t,e){super(t,e),this.kind??=39e3}static from(e){return new t(e.ndk,e)}get name(){return this.tagValue("name")}get picture(){return this.tagValue("picture")}get about(){return this.tagValue("about")}get scope(){return this.getMatchingTags("public").length>0?"public":this.getMatchingTags("public").length>0?"private":void 0}set scope(t){this.removeTag("public"),this.removeTag("private"),"public"===t?this.tags.push(["public",""]):"private"===t&&this.tags.push(["private",""])}get access(){return this.getMatchingTags("open").length>0?"open":this.getMatchingTags("closed").length>0?"closed":void 0}set access(t){this.removeTag("open"),this.removeTag("closed"),"open"===t?this.tags.push(["open",""]):"closed"===t&&this.tags.push(["closed",""])}},tS=["daily","weekly","monthly","quarterly","yearly"],tA=class t extends tg{static kind=37001;static kinds=[37001];constructor(t,e){let i=e?.kind??37001;super(t,e),this.kind=i}static from(e){return new t(e.ndk,e)}get perks(){return this.getMatchingTags("perk").map(t=>t[1]).filter(t=>void 0!==t)}addPerk(t){this.tags.push(["perk",t])}get amounts(){return this.getMatchingTags("amount").map(t=>(function(t){let e=parseInt(t[1]);if(isNaN(e)||null==e||e<=0)return;let i=t[2];if(void 0===i||""===i)return;let s=t[3];if(void 0!==s&&tS.includes(s))return{amount:e,currency:i,term:s}})(t)).filter(t=>void 0!==t)}addAmount(t,e,i){var s,n,r;this.tags.push((s=t,n=e,r=i,["amount",s.toString(),n,r]))}set relayUrl(t){this.tags.push(["r",t])}get relayUrls(){return this.getMatchingTags("r").map(t=>t[1]).filter(t=>void 0!==t)}get verifierPubkey(){return this.tagValue("p")}set verifierPubkey(t){this.removeTag("p"),t&&this.tags.push(["p",t])}get isValid(){return void 0!==this.title&&this.amounts.length>0}},t_=class t extends to{static kind=34235;static kinds=[34235,34236];_imetas;constructor(t,e){super(t,e),this.kind??=34235}static from(e){return new t(e.ndk,e.rawEvent())}get title(){return this.tagValue("title")}set title(t){this.removeTag("title"),t&&this.tags.push(["title",t])}get thumbnail(){let t;return this.imetas&&this.imetas.length>0&&(t=this.imetas[0].image?.[0]),t??this.tagValue("thumb")}get imetas(){return this._imetas||(this._imetas=this.tags.filter(t=>"imeta"===t[0]).map(tm)),this._imetas}set imetas(t){this._imetas=t,this.tags=this.tags.filter(t=>"imeta"!==t[0]),this.tags.push(...t.map(tb))}get url(){return this.imetas&&this.imetas.length>0?this.imetas[0].url:this.tagValue("url")}get published_at(){let t=this.tagValue("published_at");if(t)return parseInt(t)}set published_at(t){this.removeTag("published_at"),void 0!==t&&this.tags.push(["published_at",t.toString()])}async generateTags(){return super.generateTags(),this.published_at||(this.published_at=this.created_at),super.generateTags()}get duration(){let t=this.tagValue("duration");if(t)return parseInt(t)}set duration(t){this.removeTag("duration"),void 0!==t&&this.tags.push(["duration",Math.floor(t).toString()])}},tC=class extends tg{static kind=30818;static kinds=[30818]};function tN(t){let e=new Map;[tk,t_,tR,tg,ty,tC,tv,tE,tT,tA,tf,tw].forEach(t=>{t.kinds.forEach(i=>{e.set(i,t)})});let i=e.get(t.kind);return i?i.from(t):t}var tP=(t=>(t.ONLY_CACHE="ONLY_CACHE",t.CACHE_FIRST="CACHE_FIRST",t.PARALLEL="PARALLEL",t.ONLY_RELAY="ONLY_RELAY",t))(tP||{}),tM={closeOnEose:!1,cacheUsage:"CACHE_FIRST",dontSaveToCache:!1,groupable:!0,groupableDelay:100,groupableDelayType:"at-most",cacheUnconstrainFilter:["limit","since","until"]},tx=class extends n.EventEmitter{subId;filters;opts;pool;skipVerification=!1;skipValidation=!1;relayFilters;relaySet;ndk;debug;eventFirstSeen=new Map;eosesSeen=new Set;lastEventReceivedAt;internalId;closeOnEose;poolMonitor;skipOptimisticPublishEvent=!1;cacheUnconstrainFilter;constructor(t,e,i,s,n){super(),this.ndk=t,this.pool=i?.pool||t.pool,this.opts={...tM,...i||{}},this.filters=e instanceof Array?e:[e],this.subId=n||this.opts.subId,this.internalId=Math.random().toString(36).substring(7),this.relaySet=s,this.debug=t.debug.extend(`subscription[${this.opts.subId??this.internalId}]`),this.skipVerification=this.opts.skipVerification||!1,this.skipValidation=this.opts.skipValidation||!1,this.closeOnEose=this.opts.closeOnEose||!1,this.skipOptimisticPublishEvent=this.opts.skipOptimisticPublishEvent||!1,this.cacheUnconstrainFilter=this.opts.cacheUnconstrainFilter}relaysMissingEose(){return this.relayFilters?Array.from(this.relayFilters.keys()).filter(t=>!this.eosesSeen.has(this.pool.getRelay(t,!1,!1))):[]}get filter(){return this.filters[0]}get groupableDelay(){if(this.isGroupable())return this.opts?.groupableDelay}get groupableDelayType(){return this.opts?.groupableDelayType||"at-most"}isGroupable(){return this.opts?.groupable||!1}shouldQueryCache(){return this.opts?.cacheUsage!=="ONLY_RELAY"&&(this.filters.some(t=>t.kinds?.some(t=>tI(t))),!0)}shouldQueryRelays(){return this.opts?.cacheUsage!=="ONLY_CACHE"}shouldWaitForCache(){return this.opts.closeOnEose&&!!this.ndk.cacheAdapter?.locking&&"PARALLEL"!==this.opts.cacheUsage}start(t=!0){let e;let i=i=>{if(t)for(let t of i)this.eventReceived(t,void 0,!0,!1);else e=[],i.forEach(t=>{t.ndk=this.ndk;let i=this.opts.wrap?tN(t):t;if(i){if(i instanceof Promise){i.then(t=>{this.emitEvent(!1,t,void 0,!0,!1)});return}this.eventFirstSeen.set(i.id,Date.now()),e.push(i)}})},s=()=>{this.shouldQueryRelays()?(this.startWithRelays(),this.startPoolMonitor()):this.emit("eose",this)};return this.shouldQueryCache()?(e=this.startWithCache())instanceof Promise?(this.shouldWaitForCache()?e.then(t=>{if(i(t),tu(this)){this.emit("eose",this);return}s()}):e.then(t=>{i(t)}),null):(i(e),tu(this)?this.emit("eose",this):s(),e):(s(),null)}startPoolMonitor(){this.debug.extend("pool-monitor"),this.poolMonitor=t=>{!this.relayFilters?.has(t.url)&&I(this.ndk,this.filters,this.pool).get(t.url)&&(this.relayFilters?.set(t.url,this.filters),t.subscribe(this,this.filters))},this.pool.on("relay:connect",this.poolMonitor)}onStopped;stop(){this.emit("close",this),this.poolMonitor&&this.pool.off("relay:connect",this.poolMonitor),this.removeAllListeners(),this.onStopped?.()}hasAuthorsFilter(){return this.filters.some(t=>t.authors?.length)}startWithCache(){return this.ndk.cacheAdapter?.query?this.ndk.cacheAdapter.query(this):[]}startWithRelays(){if(this.relaySet&&0!==this.relaySet.relays.size)for(let t of(this.relayFilters=new Map,this.relaySet.relays))this.relayFilters.set(t.url,this.filters);else this.relayFilters=I(this.ndk,this.filters,this.pool);if(this.relayFilters&&0!==this.relayFilters.size)for(let[t,e]of this.relayFilters)this.pool.getRelay(t,!0,!0,e).subscribe(this,e)}eventReceived(t,e,i=!1,s=!1){let n;let r=t.id,a=this.eventFirstSeen.has(r);if(t instanceof to&&(n=t),a){let n=Date.now()-(this.eventFirstSeen.get(r)||0);if(this.emit("event:dup",t,e,n,this,i,s),e){let i=ts.get(r);i&&"string"==typeof i&&t.sig===i&&e.addValidatedEvent()}}else{if((n??=new to(this.ndk,t)).ndk=this.ndk,n.relay=e,!i&&!s){if(!this.skipValidation&&!n.isValid){this.debug("Event failed validation %s from relay %s",r,e?.url);return}if(e){if(e?.shouldValidateEvent()!==!1){if(!this.skipVerification){if(n.verifySignature(!0)||this.ndk.asyncSigVerification)e&&e.addValidatedEvent();else{this.debug("Event failed signature validation",t);return}}}else e.addNonValidatedEvent()}this.ndk.cacheAdapter&&!this.opts.dontSaveToCache&&this.ndk.cacheAdapter.setEvent(n,this.filters,e)}s&&!0===this.skipOptimisticPublishEvent||(this.emitEvent(this.opts?.wrap,n,e,i,s),this.eventFirstSeen.set(r,Date.now()))}this.lastEventReceivedAt=Date.now()}emitEvent(t=!1,e,i,s,n){let r=t?tN(e):e;r instanceof Promise?r.then(t=>this.emitEvent(!1,t,i,s,n)):r&&this.emit("event",r,i,this,s,n)}closedReceived(t,e){this.emit("closed",t,e)}eoseTimeout;eosed=!1;eoseReceived(t){this.debug("EOSE received from %s",t.url),this.eosesSeen.add(t);let e=this.lastEventReceivedAt?Date.now()-this.lastEventReceivedAt:void 0,i=this.eosesSeen.size===this.relayFilters?.size,s=tu(this),n=t=>{this.debug("Performing EOSE: %s %d",t,this.eosed),this.eosed||(this.eoseTimeout&&clearTimeout(this.eoseTimeout),this.emit("eose",this),this.eosed=!0)};if(s||i)n("query filled or seen all");else if(this.relayFilters){let t=1e3,i=new Set(this.pool.connectedRelays().map(t=>t.url)),s=Array.from(this.relayFilters.keys()).filter(t=>i.has(t));if(0===s.length)return;let r=this.eosesSeen.size/s.length;if(this.debug("Percentage of relays that have sent EOSE",{subId:this.subId,percentageOfRelaysThatHaveSentEose:r,seen:this.eosesSeen.size,total:s.length}),this.eosesSeen.size>=2&&r>=.5){if(0==(t*=1-r)){n("time to wait was 0");return}this.eoseTimeout&&clearTimeout(this.eoseTimeout);let i=()=>{void 0!==(e=this.lastEventReceivedAt?Date.now()-this.lastEventReceivedAt:void 0)&&e<20?this.eoseTimeout=setTimeout(i,t):n("send eose timeout: "+t)};this.eoseTimeout=setTimeout(i,t)}}}},tI=t=>t>=2e4&&t<3e4;async function tD(t,e,i=3){if(!this.ndk)throw Error("NDK not set");let s=await this.ndk.fetchEvent({kinds:[i],authors:[this.pubkey]},t||{groupable:!1});if(s){let t=new Set;return s.tags.forEach(e=>{"p"===e[0]&&t.add(e[1])}),e&&this.ndk?.outboxTracker?.trackUsers(Array.from(t)),[...t].reduce((t,e)=>{let i=new tO({pubkey:e});return i.ndk=this.ndk,t.add(i),t},new Set)}return new Set}var tU=/^(?:([\w.+-]+)@)?([\w.-]+)$/;async function tV(t,e,i=fetch,s={}){return await t.queuesNip05.add({id:e,func:async()=>{if(t.cacheAdapter&&t.cacheAdapter.loadNip05){let i=await t.cacheAdapter.loadNip05(e);if("missing"!==i){if(i){let e=new tO({pubkey:i.pubkey,relayUrls:i.relays,nip46Urls:i.nip46});return e.ndk=t,e}if("no-cache"!==s.cache)return null}}let n=e.match(tU);if(!n)return null;let[r,a="_",o]=n;try{let n=await i(`https://${o}/.well-known/nostr.json?name=${a}`,s),{names:r,relays:h,nip46:l}=function(t){let e={names:{}};for(let[i,s]of Object.entries(t.names))"string"==typeof i&&"string"==typeof s&&(e.names[i.toLowerCase()]=s);if(t.relays)for(let[i,s]of(e.relays={},Object.entries(t.relays)))"string"==typeof i&&Array.isArray(s)&&(e.relays[i]=s.filter(t=>"string"==typeof t));if(t.nip46)for(let[i,s]of(e.nip46={},Object.entries(t.nip46)))"string"==typeof i&&Array.isArray(s)&&(e.nip46[i]=s.filter(t=>"string"==typeof t));return e}(await n.json()),u=r[a.toLowerCase()],c=null;return u&&(c={pubkey:u,relays:h?.[u],nip46:l?.[u]}),t?.cacheAdapter&&t.cacheAdapter.saveNip05&&t.cacheAdapter.saveNip05(e,c),c}catch(i){return t?.cacheAdapter&&t.cacheAdapter.saveNip05&&t?.cacheAdapter.saveNip05(e,null),console.error("Failed to fetch NIP05 for",e,i),null}}})}var tO=class t{ndk;profile;profileEvent;_npub;_pubkey;relayUrls=[];nip46Urls=[];constructor(t){t.npub&&(this._npub=t.npub),t.hexpubkey&&(this._pubkey=t.hexpubkey),t.pubkey&&(this._pubkey=t.pubkey),t.relayUrls&&(this.relayUrls=t.relayUrls),t.nip46Urls&&(this.nip46Urls=t.nip46Urls)}get npub(){if(!this._npub){if(!this._pubkey)throw Error("pubkey not set");this._npub=a.Qe.npubEncode(this.pubkey)}return this._npub}get nprofile(){let t=this.profileEvent?.onRelays?.map(t=>t.url);return a.Qe.nprofileEncode({pubkey:this.pubkey,relays:t})}set npub(t){this._npub=t}get pubkey(){if(!this._pubkey){if(!this._npub)throw Error("npub not set");this._pubkey=a.Qe.decode(this.npub).data}return this._pubkey}set pubkey(t){this._pubkey=t}filter(){return{"#p":[this.pubkey]}}async getZapInfo(t){if(!this.ndk)throw Error("No NDK instance found");let e=async e=>{if(!t)return e;try{return await Promise.race([e,new Promise((e,i)=>setTimeout(()=>i(),t))])}catch{return}},[i,s]=await Promise.all([e(this.fetchProfile()),e(this.ndk.fetchEvent({kinds:[10019],authors:[this.pubkey]}))]),n=new Map;if(s){let t=tR.from(s);t.mints.length>0&&n.set("nip61",{mints:t.mints,relays:t.relays,p2pk:t.p2pk})}if(i){let{lud06:t,lud16:e}=i;n.set("nip57",{lud06:t,lud16:e})}return n}static async fromNip05(e,i,s=!1){if(!i)throw Error("No NDK instance found");let n={};s&&(n.cache="no-cache");let r=await tV(i,e,i?.httpFetch,n);if(r){let e=new t({pubkey:r.pubkey,relayUrls:r.relays,nip46Urls:r.nip46});return e.ndk=i,e}}async fetchProfile(t,e=!1){if(!this.ndk)throw Error("NDK not set");this.profile||(this.profile={});let i=null;if(this.ndk.cacheAdapter&&this.ndk.cacheAdapter.fetchProfile&&t?.cacheUsage!=="ONLY_RELAY"){let t=await this.ndk.cacheAdapter.fetchProfile(this.pubkey);if(t)return this.profile=t,t}return(!t&&this.ndk.cacheAdapter&&this.ndk.cacheAdapter.locking&&(i=await this.ndk.fetchEvent({kinds:[0],authors:[this.pubkey]},{cacheUsage:"ONLY_CACHE",closeOnEose:!0,groupable:!1}),t={cacheUsage:"ONLY_RELAY",closeOnEose:!0,groupable:!0,groupableDelay:250}),i||(i=await this.ndk.fetchEvent({kinds:[0],authors:[this.pubkey]},t)),i)?(this.profile=function(t){let e;let i={};try{e=JSON.parse(t.content)}catch(t){throw Error(`Failed to parse profile event: ${t}`)}return i.created_at=t.created_at,i.profileEvent=JSON.stringify(t.rawEvent()),Object.keys(e).forEach(t=>{switch(t){case"name":i.name=e.name;break;case"display_name":i.displayName=e.display_name;break;case"image":case"picture":i.picture=e.picture||e.image,i.image=i.picture;break;case"banner":i.banner=e.banner;break;case"bio":i.bio=e.bio;break;case"nip05":i.nip05=e.nip05;break;case"lud06":i.lud06=e.lud06;break;case"lud16":i.lud16=e.lud16;break;case"about":i.about=e.about;break;case"website":i.website=e.website;break;default:i[t]=e[t]}}),i}(i),e&&(this.profile.profileEvent=JSON.stringify(i)),this.profile&&this.ndk.cacheAdapter&&this.ndk.cacheAdapter.saveProfile&&this.ndk.cacheAdapter.saveProfile(this.pubkey,this.profile),this.profile):null}follows=tD.bind(this);async followSet(t,e,i=3){return new Set(Array.from(await this.follows(t,e,i)).map(t=>t.pubkey))}tagReference(){return["p",this.pubkey]}referenceTags(t){let e=[["p",this.pubkey]];return t&&e[0].push("",t),e}async publish(){if(!this.ndk)throw Error("No NDK instance found");if(!this.profile)throw Error("No profile available");this.ndk.assertSigner();let t=new to(this.ndk,{kind:0,content:function(t){let e={};for(let[i,s]of Object.entries(t))switch(i){case"username":case"name":e.name=s;break;case"displayName":e.display_name=s;break;case"image":case"picture":e.picture=s;break;case"bio":case"about":e.about=s;break;default:e[i]=s}return JSON.stringify(e)}(this.profile)});await t.publish()}async follow(t,e,i=3){if(!this.ndk)throw Error("No NDK instance found");if(this.ndk.assertSigner(),e||(e=await this.follows(void 0,void 0,i)),e.has(t))return!1;e.add(t);let s=new to(this.ndk,{kind:i});for(let t of e)s.tag(t);return await s.publish(),!0}async unfollow(t,e,i=3){if(!this.ndk)throw Error("No NDK instance found");this.ndk.assertSigner(),e||(e=await this.follows(void 0,void 0,i));let s=new Set,n=!1;for(let i of e)i.pubkey!==t.pubkey?s.add(i):n=!0;if(!n)return!1;let r=new to(this.ndk,{kind:i});for(let t of s)r.tag(t);return await r.publish()}async validateNip05(t){if(!this.ndk)throw Error("No NDK instance found");let e=await tV(this.ndk,t);return null===e?null:e.pubkey===this.pubkey}},tF=(t=>(t.Processing="processing",t.Success="success",t.Scheduled="scheduled",t.PayReq="payment_required",t))(tF||{}),tL=class t extends to{constructor(t,e){super(t,e),this.kind??=7e3}static async from(e){let i=new t(e.ndk,e.rawEvent());return i.encrypted&&await i.dvmDecrypt(),i}get status(){return this.tagValue("status")}set status(t){this.removeTag("status"),void 0!==t&&this.tags.push(["status",t])}get encrypted(){return!!this.getMatchingTags("encrypted")[0]}async dvmDecrypt(){await this.decrypt();let t=JSON.parse(this.content);this.tags.push(...t)}},t$="read",tz="write",tq=class t extends to{constructor(t,e){super(t,e),this.kind??=10002}static from(e){return new t(e.ndk,e.rawEvent())}get readRelayUrls(){return this.tags.filter(t=>"r"===t[0]||"relay"===t[0]).filter(t=>!t[2]||t[2]&&t[2]===t$).map(t=>y(t[1])).filter(t=>!!t)}set readRelayUrls(t){for(let e of t)this.tags.push(["r",e,t$])}get writeRelayUrls(){return this.tags.filter(t=>"r"===t[0]||"relay"===t[0]).filter(t=>!t[2]||t[2]&&t[2]===tz).map(t=>y(t[1])).filter(t=>!!t)}set writeRelayUrls(t){for(let e of t)this.tags.push(["r",e,tz])}get bothRelayUrls(){return this.tags.filter(t=>"r"===t[0]||"relay"===t[0]).filter(t=>!t[2]).map(t=>t[1])}set bothRelayUrls(t){for(let e of t)this.tags.push(["r",e])}get relays(){return this.tags.filter(t=>"r"===t[0]||"relay"===t[0]).map(t=>t[1])}get relaySet(){if(!this.ndk)throw Error("NDKRelayList has no NDK instance");return new P(new Set(this.relays.map(t=>this.ndk.pool.getRelay(t))),this.ndk)}};function tG(t,e){try{let i=JSON.parse(e.content),s=new tq(t),n=new Set,r=new Set;for(let[t,e]of Object.entries(i)){try{t=m(t)}catch{continue}e?(e.write&&r.add(t),e.read&&n.add(t)):(n.add(t),r.add(t))}return s.readRelayUrls=Array.from(n),s.writeRelayUrls=Array.from(r),s}catch{}}async function tW(t,e,i,s,n,r){try{await t.sign(i),n(t)}catch(i){s(`Failed to publish auth event to relay ${e.url}`,i),r(t)}}var tH={signIn:function({ndk:t,signer:e,debug:i}={}){return i??=r("ndk:auth-policies:signIn"),async(s,n)=>{i(`Relay ${s.url} requested authentication, signing in`);let r=new to(t);return r.kind=22242,r.tags=[["relay",s.url],["challenge",n]],e??=t?.signer,new Promise(async(n,a)=>{e?await tW(r,s,e,i,n,a):t?.once("signer:ready",async t=>{await tW(r,s,t,i,n,a)})})}}},tK=class{_userPromise;encryptionQueue=[];encryptionProcessing=!1;debug;waitTimeout;constructor(t=1e3){this.debug=r("ndk:nip07"),this.waitTimeout=t}async blockUntilReady(){await this.waitForExtension();let t=await window.nostr.getPublicKey();if(!t)throw Error("User rejected access");return new tO({pubkey:t})}async user(){return this._userPromise||(this._userPromise=this.blockUntilReady()),this._userPromise}async sign(t){return await this.waitForExtension(),(await window.nostr.signEvent(t)).sig}async relays(t){await this.waitForExtension();let e=await window.nostr.getRelays?.()||{},i=[];for(let t of Object.keys(e))e[t].read&&e[t].write&&i.push(t);return i.map(e=>new C(e,t?.relayAuthDefaultPolicy,t))}async encryptionEnabled(t){let e=[];return(!t||"nip04"==t)&&window.nostr.nip04&&e.push("nip04"),(!t||"nip44"==t)&&window.nostr.nip44&&e.push("nip44"),e}async encrypt(t,e,i="nip04"){if(!await this.encryptionEnabled(i))throw Error(i+"encryption is not available from your browser extension");await this.waitForExtension();let s=t.pubkey;return this.queueEncryption(i,"encrypt",s,e)}async decrypt(t,e,i="nip04"){if(!await this.encryptionEnabled(i))throw Error(i+"encryption is not available from your browser extension");await this.waitForExtension();let s=t.pubkey;return this.queueEncryption(i,"decrypt",s,e)}async queueEncryption(t,e,i,s){return new Promise((n,r)=>{this.encryptionQueue.push({scheme:t,method:e,counterpartyHexpubkey:i,value:s,resolve:n,reject:r}),this.encryptionProcessing||this.processEncryptionQueue()})}async processEncryptionQueue(t,e=0){if(!t&&0===this.encryptionQueue.length){this.encryptionProcessing=!1;return}this.encryptionProcessing=!0;let{scheme:i,method:s,counterpartyHexpubkey:n,value:r,resolve:a,reject:o}=t||this.encryptionQueue.shift();this.debug("Processing encryption queue item",{method:s,counterpartyHexpubkey:n,value:r});try{let t=await window.nostr[i][s](n,r);a(t)}catch(i){if(i.message&&i.message.includes("call already executing")&&e<5){this.debug("Retrying encryption queue item",{method:s,counterpartyHexpubkey:n,value:r,retries:e}),setTimeout(()=>{this.processEncryptionQueue(t,e+1)},50*e);return}o(i)}this.processEncryptionQueue()}waitForExtension(){return new Promise((t,e)=>{let i;if(window.nostr){t();return}let s=setInterval(()=>{window.nostr&&(clearTimeout(i),clearInterval(s),t())},100);i=setTimeout(()=>{clearInterval(s),e(Error("NIP-07 extension not available"))},this.waitTimeout)})}};async function tj(t,e,i,s,n){if(!await t.pubkeyAllowed({id:e,pubkey:i,method:"nip04_decrypt",params:n})){t.debug(`decrypt request from ${i} rejected`);return}return await t.signer.decrypt(s,n,"nip04")}n.EventEmitter;async function tQ(t,e,i,s,n){if(!await t.pubkeyAllowed({id:e,pubkey:i,method:"nip04_encrypt",params:n})){t.debug(`encrypt request from ${i} rejected`);return}return await t.signer.encrypt(s,n,"nip04")}async function tB(t,e,i,s){let[n]=s;t.debug(`sign event request from ${i}`);let r=new to(t.ndk,JSON.parse(n));if(t.debug("event to sign",r.rawEvent()),!await t.pubkeyAllowed({id:e,pubkey:i,method:"sign_event",params:r})){t.debug(`sign event request from ${i} rejected`);return}return t.debug(`sign event request from ${i} allowed`),await r.sign(t.signer),r}async function tJ(t,e,i,s,n){if(!await t.pubkeyAllowed({id:e,pubkey:i,method:"nip44_encrypt",params:n})){t.debug(`encrypt request from ${i} rejected`);return}return await t.signer.encrypt(s,n,"nip44")}async function tY(t,e,i,s,n){if(!await t.pubkeyAllowed({id:e,pubkey:i,method:"nip44_decrypt",params:n})){t.debug(`decrypt request from ${i} rejected`);return}return await t.signer.decrypt(s,n,"nip44")}async function tZ(t,e){return(await tX([t],e)).get(t)}async function tX(t,e,i=!1,s=1e3){let n=e.outboxPool||e.pool,r=new Set;for(let t of n.relays.values())r.add(t);let a=new Map,o=new Map,h=new P(r,e);if(e.cacheAdapter?.locking&&!i){let i=await e.fetchEvents({kinds:[3,10002],authors:Array.from(new Set(t))},{cacheUsage:"ONLY_CACHE",subId:"ndk-relay-list-fetch"});for(let t of i)10002===t.kind&&a.set(t.pubkey,tq.from(t));for(let t of i)if(3===t.kind){if(a.has(t.pubkey))continue;let i=tG(e,t);i&&o.set(t.pubkey,i)}t=t.filter(t=>!a.has(t)&&!o.has(t))}if(0===t.length)return a;let l=new Map,u=new Map;return new Promise(async i=>{let r=e.subscribe({kinds:[3,10002],authors:t},{closeOnEose:!0,pool:n,groupable:!0,cacheUsage:"ONLY_RELAY",subId:"ndk-relay-list-fetch"},h,!1);r.on("event",t=>{if(10002===t.kind){let e=l.get(t.pubkey);e&&e.created_at>t.created_at||l.set(t.pubkey,t)}else if(3===t.kind){let e=u.get(t.pubkey);if(e&&e.created_at>t.created_at)return;u.set(t.pubkey,t)}}),r.on("eose",()=>{for(let t of l.values())a.set(t.pubkey,tq.from(t));for(let i of t){if(a.has(i))continue;let t=u.get(i);if(!t)continue;let s=tG(e,t);s&&a.set(i,s)}i(a)}),setTimeout(()=>{i(a)},s),r.start()})}n.EventEmitter;var t0=class{type;relayUrlScores;readRelays;writeRelays;constructor(t){this.type=t,this.relayUrlScores=new Map,this.readRelays=new Set,this.writeRelays=new Set}},t1=class extends n.EventEmitter{data;ndk;debug;constructor(t){super(),this.ndk=t,this.debug=t.debug.extend("outbox-tracker"),this.data=new u.LRUCache({maxSize:1e5,entryExpirationTimeInMS:12e4})}async trackUsers(t,e=!1){let i=[];for(let s=0;s<t.length;s+=400){let n=t.slice(s,s+400).map(t=>t3(t)).filter(t=>!this.data.has(t));if(0!==n.length){for(let t of n)this.data.set(t,new t0("user"));i.push(new Promise(t=>{tX(n,this.ndk,e).then(t=>{for(let[e,i]of t){let t=this.data.get(e);if(t??=new t0("user"),i){for(let e of(t.readRelays=new Set(b(i.readRelayUrls)),t.writeRelays=new Set(b(i.writeRelayUrls)),t.readRelays))this.ndk.pool.blacklistRelayUrls.has(e)&&t.readRelays.delete(e);for(let e of t.writeRelays)this.ndk.pool.blacklistRelayUrls.has(e)&&t.writeRelays.delete(e);this.data.set(e,t)}}}).finally(t)}))}}return Promise.all(i)}track(t,e,i=!0){let s=t3(t);e??=t instanceof tO?"user":"kind";let n=this.data.get(s);return!n&&(n=new t0(e),t instanceof tO&&this.trackUsers([t])),n}};function t3(t){return t instanceof tO?t.pubkey:t}function t4(t){if(!t||""===t)return!1;try{return new URL(t),!0}catch(t){return!1}}async function t2(t,e,i,s={type:"timeout"}){let n;let r=this.debug.extend("fetch-event-from-tag"),[a,o,h]=t;r("fetching event from tag",t,i={},s);let l=p(this,e.pubkey);if(l&&l.size>0){r("fetching event from author relays %o",Array.from(l));let t=P.fromRelayUrls(Array.from(l),this),e=await this.fetchEvent(o,i,t);if(e)return e}else r("no author relays found for %s",e.pubkey,e);r("fetching event without relay hint",I(this,[{ids:[o]}],this.pool));let u=await this.fetchEvent(o,i);if(u)return u;if(h&&""!==h){let t=await this.fetchEvent(o,i,this.pool.getRelay(h,!0,!0,[{ids:[o]}]));if(t)return t}let c=t4(h)?this.pool.getRelay(h,!1,!0,[{ids:[o]}]):void 0,d=new Promise(t=>{this.fetchEvent(o,i,c).then(t)});if(!t4(h)||"none"===s.type)return d;let g=new Promise(async t=>{let e=s.relaySet,a=s.timeout??1500,h=new Promise(t=>setTimeout(t,a));"timeout"===s.type&&await h,n?t(n):(r("fallback fetch triggered"),t(await this.fetchEvent(o,i,e)))});switch(s.type){case"timeout":return Promise.race([d,g]);case"eose":if(n=await d)return n;return g}}var t5=class{ndk;spec;url;nip98Required=!1;constructor(t,e){this.url=`https://${t}/.well-known/nostr/nip96.json`,this.ndk=e}async prepareUpload(t,e="POST"){if(this.validateHttpFetch(),this.spec||await this.fetchSpec(),!this.spec)throw Error("Failed to fetch NIP96 spec");let i={};return this.nip98Required&&(i={Authorization:await this.generateNip98Header(this.spec.api_url,e,t)}),{url:this.spec.api_url,headers:i}}async xhrUpload(t,e){let i="POST",{url:s,headers:n}=await this.prepareUpload(e,i);t.open(i,s,!0),n.Authorization&&t.setRequestHeader("Authorization",n.Authorization);let r=new FormData;return r.append("file",e),new Promise((e,i)=>{t.onload=function(){t.status>=200&&t.status<300?e(JSON.parse(t.responseText)):i(Error(t.statusText))},t.onerror=function(){i(Error("Network Error"))},t.send(r)})}async upload(t){let e="POST",{url:i,headers:s}=await this.prepareUpload(t,e),n=new FormData;n.append("file",t);let r=await this.ndk.httpFetch(this.spec.api_url,{method:e,headers:s,body:n});if(200!==r.status)throw Error(`Failed to upload file to ${i}`);let a=await r.json();if("success"!==a.status)throw Error(a.message);return a}validateHttpFetch(){if(!this.ndk)throw Error("NDK is required to fetch NIP96 spec");if(!this.ndk.httpFetch)throw Error("NDK must have an httpFetch method to fetch NIP96 spec")}async fetchSpec(){this.validateHttpFetch();let t=await this.ndk.httpFetch(this.url);if(200!==t.status)throw Error(`Failed to fetch NIP96 spec from ${this.url}`);let e=await t.json();if(!e)throw Error(`Failed to parse NIP96 spec from ${this.url}`);this.spec=e,this.nip98Required=this.spec.plans.free.is_nip98_required}async generateNip98Header(t,e,i){let s=new to(this.ndk,{kind:27235,tags:[["u",t],["method",e]]});if(["POST","PUT","PATCH"].includes(e)){let t=await this.calculateSha256(i);s.tags.push(["payload",t])}await s.sign();let n=btoa(JSON.stringify(s.rawEvent()));return`Nostr ${n}`}async calculateSha256(t){let e=await t.arrayBuffer();return Array.from(new Uint8Array(await crypto.subtle.digest("SHA-256",e))).map(t=>t.toString(16).padStart(2,"0")).join("")}},t9=class{queue=[];maxConcurrency;processing=new Set;promises=new Map;constructor(t,e){this.maxConcurrency=e}add(t){if(this.promises.has(t.id))return this.promises.get(t.id);let e=new Promise((e,i)=>{this.queue.push({...t,func:()=>t.func().then(t=>(e(t),t),t=>{throw i(t),t})}),this.process()});return this.promises.set(t.id,e),e.finally(()=>{this.promises.delete(t.id),this.processing.delete(t.id),this.process()}),e}process(){if(this.processing.size>=this.maxConcurrency||0===this.queue.length)return;let t=this.queue.shift();!(!t||this.processing.has(t.id))&&(this.processing.add(t.id),t.func())}clear(){this.queue=[]}clearProcessing(){this.processing.clear()}clearAll(){this.clear(),this.clearProcessing()}length(){return this.queue.length}},t6=class{subscriptions;seenEvents=new Map;constructor(){this.subscriptions=new Map}add(t){this.subscriptions.set(t.internalId,t),t.onStopped&&console.log("SUB-MANAGER BUG: Subscription already had onStopped! \uD83E\uDD14",t.internalId),t.onStopped=()=>{this.subscriptions.delete(t.internalId)},t.on("close",()=>{this.subscriptions.delete(t.internalId)})}seenEvent(t,e){let i=this.seenEvents.get(t)||[];i.push(e),this.seenEvents.set(t,i)}dispatchEvent(t,e,i=!1){e&&this.seenEvent(t.id,e);let s=this.subscriptions.values(),n=[];for(let e of s)(0,a.XN)(e.filters,t)&&n.push(e);for(let s of n)s.eventReceived(t,e,!1,i)}},t7=r("ndk:active-user");async function t8(t){if(!this.autoConnectUserRelays)return;let e=await tZ(t.pubkey,this);if(e){for(let t of e.relays){let e=this.pool.relays.get(t);e||(e=new C(t,this.relayAuthDefaultPolicy,this),this.pool.addRelay(e))}return e}}async function et(t){let e=this.outboxPool||this.pool;e.connectedRelays.length>0?ee.call(this,t):e.once("connect",()=>{ee.call(this,t)})}async function ee(t){let e=await t8.call(this,t),i=[{kinds:[10006],authors:[t.pubkey]}];this.autoFetchUserMutelist&&i[0].kinds.push(1e4);let s=e?e.relaySet:void 0,n=this.subscribe(i,{subId:"active-user-settings",closeOnEose:!0},s,!1),r=new Map;n.on("event",t=>{let e=r.get(t.kind);e&&e.created_at>=t.created_at||r.set(t.kind,t)}),n.on("eose",()=>{for(let t of r.values())ei.call(this,t)}),n.start()}async function ei(t){10006===t.kind?es.call(this,t):1e4===t.kind&&en.call(this,t)}function es(t){let e=tw.from(t);for(let t of e.items)this.pool.blacklistRelayUrls.add(t[0]);t7("Added %d relays to relay blacklist",e.items.length)}function en(t){let e=tw.from(t);for(let t of e.items)this.mutedIds.set(t[1],t[0]);t7("Added %d users to mute list",e.items.length)}var er=["wss://purplepag.es/","wss://nos.lol/"],ea=["wss://brb.io/","wss://nostr.mutinywallet.com/"],eo=class extends n.EventEmitter{_explicitRelayUrls;blacklistRelayUrls;pool;outboxPool;_signer;_activeUser;cacheAdapter;debug;devWriteRelaySet;outboxTracker;mutedIds;clientName;clientNip89;queuesZapConfig;queuesNip05;asyncSigVerification=!1;initialValidationRatio=1;lowestValidationRatio=1;validationRatioFn;subManager;publishingFailureHandled=!1;pools=[];relayAuthDefaultPolicy;httpFetch;netDebug;autoConnectUserRelays=!0;autoFetchUserMutelist=!0;walletConfig;constructor(t={}){super(),this.debug=t.debug||r("ndk"),this.netDebug=t.netDebug,this._explicitRelayUrls=t.explicitRelayUrls||[],this.blacklistRelayUrls=t.blacklistRelayUrls||ea,this.subManager=new t6,this.pool=new tl(t.explicitRelayUrls||[],[],this),this.pool.name="Main",this.pool.on("relay:auth",async(t,e)=>{this.relayAuthDefaultPolicy&&await this.relayAuthDefaultPolicy(t,e)}),this.autoConnectUserRelays=t.autoConnectUserRelays??!0,this.autoFetchUserMutelist=t.autoFetchUserMutelist??!0,this.clientName=t.clientName,this.clientNip89=t.clientNip89,this.relayAuthDefaultPolicy=t.relayAuthDefaultPolicy,t.enableOutboxModel&&(this.outboxPool=new tl(t.outboxRelayUrls||er,[],this,{debug:this.debug.extend("outbox-pool"),name:"Outbox Pool"}),this.outboxTracker=new t1(this)),this.signer=t.signer,this.cacheAdapter=t.cacheAdapter,this.mutedIds=t.mutedIds||new Map,t.devWriteRelayUrls&&(this.devWriteRelaySet=P.fromRelayUrls(t.devWriteRelayUrls,this)),this.queuesZapConfig=new t9("zaps",3),this.queuesNip05=new t9("nip05",10),this.signatureVerificationWorker=t.signatureVerificationWorker,this.initialValidationRatio=t.initialValidationRatio||1,this.lowestValidationRatio=t.lowestValidationRatio||1;try{this.httpFetch=fetch}catch{}}set explicitRelayUrls(t){this._explicitRelayUrls=t,this.pool.relayUrls=t}get explicitRelayUrls(){return this._explicitRelayUrls||[]}set signatureVerificationWorker(t){this.asyncSigVerification=!!t,t&&((s=t).onmessage=t=>{let[e,i]=t.data,s=X[e];if(!s){console.error("No record found for event",e);return}for(let t of(delete X[e],s.resolves))t(i)})}addExplicitRelay(t,e,i=!0){let s;return s="string"==typeof t?new C(t,e,this):t,this.pool.addRelay(s,i),this.explicitRelayUrls.push(s.url),s}toJSON(){return({relayCount:this.pool.relays.size}).toString()}get activeUser(){return this._activeUser}set activeUser(t){let e=this._activeUser?.pubkey!==t?.pubkey;this._activeUser=t,t&&e?et.call(this,t):t||(this.mutedIds=new Map)}get signer(){return this._signer}set signer(t){this._signer=t,t&&this.emit("signer:ready",t),t?.user().then(t=>{t.ndk=this,this.activeUser=t})}async connect(t){this._signer&&this.autoConnectUserRelays&&(this.debug("Attempting to connect to user relays specified by signer %o",await this._signer.relays?.(this)),this._signer.relays&&(await this._signer.relays(this)).forEach(t=>this.pool.addRelay(t)));let e=[this.pool.connect(t)];return this.outboxPool&&e.push(this.outboxPool.connect(t)),this.debug("Connecting to relays %o",{timeoutMs:t}),Promise.allSettled(e).then(()=>{})}getUser(t){let e=new tO(t);return e.ndk=this,e}async getUserFromNip05(t,e=!1){return tO.fromNip05(t,this,e)}subscribe(t,e,i,s=!0){let n=new tx(this,t,e,i);this.subManager.add(n);let r=e?.pool??this.pool;if(i)for(let t of i.relays)r.useTemporaryRelay(t,void 0,n.filters);if(this.outboxPool&&n.hasAuthorsFilter()){let t=n.filters.filter(t=>t.authors&&t.authors?.length>0).map(t=>t.authors).flat();this.outboxTracker?.trackUsers(t)}if(s){let t;"object"==typeof s&&(s.onEvent&&n.on("event",s.onEvent),s.onEose&&n.on("eose",s.onEose),s.onEvents&&(t=s.onEvents)),setTimeout(()=>{let e=n.start(!t);e&&t&&t(e)},0)}return n}async publish(t,e,i){return this.debug("Deprecated: Use `event.publish()` instead"),t.publish(e,i)}fetchEventFromTag=t2.bind(this);fetchEventSync(t){let e;if(!this.cacheAdapter)throw Error("Cache adapter not set");let i=new tx(this,"string"==typeof t?[tc(t)]:t),s=this.cacheAdapter.query(i);if(s instanceof Promise)throw Error("Cache adapter is async");return s.map(t=>(t.ndk=this,t))}async fetchEvent(t,e,i){let s,n;if(i instanceof C?n=new P(new Set([i]),this):i instanceof P&&(n=i),!i&&"string"==typeof t&&null===t.match(td)){let e=function(t,e){try{let i=a.Qe.decode(t);if(["naddr","nevent"].includes(i?.type)){let t=i.data;if(t?.relays)return t.relays.map(t=>new C(t,e.relayAuthDefaultPolicy,e))}}catch(t){}return[]}(t,this);e.length>0&&(n=function(t,e){let i=e.connectedRelays();if(!Array.from(t.relays).some(t=>i.map(t=>t.url).includes(t.url)))for(let e of i)t.addRelay(e);if(0===i.length)for(let i of e.relays.values())t.addRelay(i);return t}(n=new P(new Set(e),this),this.pool))}if(0===(s="string"==typeof t?[tc(t)]:Array.isArray(t)?t:[t]).length)throw Error(`Invalid filter: ${JSON.stringify(t)}`);return new Promise(t=>{let i=null,r=this.subscribe(s,{...e||{},closeOnEose:!0},n,!1),a=setTimeout(()=>{r.stop(),t(i)},1e4);r.on("event",e=>{e.ndk=this,e.isReplaceable()?(!i||i.created_at<e.created_at)&&(i=e):(clearTimeout(a),t(e))}),r.on("eose",()=>{clearTimeout(a),t(i)}),r.start()})}async fetchEvents(t,e,i){return new Promise(s=>{let n=new Map,r=this.subscribe(t,{...e||{},closeOnEose:!0},i,!1);r.on("event",t=>{t instanceof to||(t=new to(void 0,t));let e=t.deduplicationKey(),i=n.get(e);if(i){var s;s=t,t=i.created_at>s.created_at?i:s}t.ndk=this,n.set(e,t)}),r.on("eose",()=>{s(new Set(n.values()))}),r.start()})}assertSigner(){if(!this.signer)throw this.emit("signer:required"),Error("Signer required")}getNip96(t){return new t5(t,this)}set wallet(t){if(!t){this.walletConfig=void 0;return}this.walletConfig??={},this.walletConfig.lnPay=t?.lnPay?.bind(t),this.walletConfig.cashuPay=t?.cashuPay?.bind(t)}},eh=r("ndk:zapper:ln");r("ndk:zapper"),n.EventEmitter}}]);
//# sourceMappingURL=5620042a-8f9a6e5defadd0e5.js.map