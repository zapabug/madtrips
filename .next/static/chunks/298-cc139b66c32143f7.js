"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[298],{3492:(e,t,o)=>{o.d(t,{M:()=>i});var r=o(3130),n=o(1368);class i{getClientPubkey(){return this.clientPubkey}getRemotePubkey(){return this.remotePubkey}isConnected(){return this.connectionEstablished}generateRequestId(){return(0,n.A)()}async encryptForRemote(e){try{return await r.sh.encrypt(this.clientPrivkey,this.remotePubkey,e)}catch(e){throw console.error("Failed to encrypt message:",e),Error("Encryption failed")}}async decryptFromRemote(e){try{return await r.sh.decrypt(this.clientPrivkey,this.remotePubkey,e)}catch(e){throw console.error("Failed to decrypt message:",e),Error("Decryption failed")}}async sendRequest(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!this.connectionEstablished)throw Error("Not connected to remote signer");let o=this.generateRequestId(),r=new Promise((e,t)=>{this.pendingRequests.set(o,{resolve:e,reject:t}),setTimeout(()=>{this.pendingRequests.has(o)&&(this.pendingRequests.delete(o),t(Error("Request timeout after ".concat(this.timeout,"ms"))))},this.timeout)});try{return await this.encryptForRemote(JSON.stringify({id:o,method:e,params:t})),console.log("Sending NIP-47 request: ".concat(e)),this.simulateResponseFromRemote(o,e,t),await r}catch(e){throw this.pendingRequests.has(o)&&this.pendingRequests.delete(o),e}}async processResponse(e){try{let t=await this.decryptFromRemote(e.content),o=JSON.parse(t),r=this.pendingRequests.get(o.id);if(!r){console.warn("Received response for unknown request ID: ".concat(o.id));return}this.pendingRequests.delete(o.id),o.error?r.reject(Error("Remote error (".concat(o.error.code,"): ").concat(o.error.message))):r.resolve(o.result)}catch(e){console.error("Failed to process response:",e)}}simulateResponseFromRemote(e,t,o){setTimeout(async()=>{let r=this.pendingRequests.get(e);if(r)try{let e;switch(t){case"get_public_key":e=this.remotePubkey;break;case"sign_event":e={...o.event,sig:"00".repeat(32)};break;case"connect":e={approved:!0};break;case"pay_invoice":e={preimage:"00".repeat(16)};break;default:throw Error("Unsupported method: ".concat(t))}r.resolve(e)}catch(e){r.reject(e)}finally{this.pendingRequests.delete(e)}},1e3)}async connect(){if(!this.remotePubkey)throw Error("Remote pubkey is required");console.log("Connecting to remote signer: ".concat(this.remotePubkey," via ").concat(this.relayUrl||"default relays"));try{await new Promise(e=>setTimeout(e,500)),this.connectionEstablished=!0,console.log("Connected to remote signer successfully")}catch(e){throw console.error("Failed to connect to remote signer:",e),e}}async getPublicKey(){if(!this.connectionEstablished)throw Error("Not connected to remote signer");try{return await this.sendRequest("get_public_key")}catch(e){throw console.error("Failed to get public key from remote signer:",e),e}}async signEvent(e){if(!this.connectionEstablished)throw Error("Not connected to remote signer");try{return await this.sendRequest("sign_event",{event:e})}catch(e){throw console.error("Failed to sign event with remote signer:",e),e}}async encrypt(e,t){if(!this.connectionEstablished)throw Error("Not connected to remote signer");try{return await this.sendRequest("nip04_encrypt",{pubkey:e,plaintext:t})}catch(e){throw console.error("Failed to encrypt with remote signer:",e),e}}async decrypt(e,t){if(!this.connectionEstablished)throw Error("Not connected to remote signer");try{return await this.sendRequest("nip04_decrypt",{pubkey:e,ciphertext:t})}catch(e){throw console.error("Failed to decrypt with remote signer:",e),e}}async getInfo(){if(!this.connectionEstablished)throw Error("Not connected to remote signer");try{return await this.sendRequest("get_info")}catch(e){throw console.error("Failed to get wallet info from remote signer:",e),e}}async getBalance(){if(!this.connectionEstablished)throw Error("Not connected to remote signer");try{return await this.sendRequest("get_balance")}catch(e){throw console.error("Failed to get balance from remote signer:",e),e}}async payInvoice(e){if(!this.connectionEstablished)throw Error("Not connected to remote signer");try{console.log("Sending payment request for invoice:",e.substring(0,30)+"...");let t=await this.sendRequest("pay_invoice",{invoice:e});return console.log("Payment successful:",t),t}catch(e){throw console.error("Payment failed:",e),e}}async createPaymentRequestEvent(e){if(!this.connectionEstablished)throw Error("Not connected to remote signer");let t=this.generateRequestId(),o=await this.encryptForRemote(JSON.stringify({id:t,method:"pay_invoice",params:{invoice:e}}));return{kind:24133,created_at:Math.floor(Date.now()/1e3),tags:[["p",this.remotePubkey]],content:o,pubkey:this.clientPubkey}}async processPaymentResponse(e){try{let t=await this.decryptFromRemote(e.content);return JSON.parse(t)}catch(e){throw console.error("Failed to process payment response:",e),Error("Invalid payment response")}}async getCapabilities(){if(!this.connectionEstablished)throw Error("Not connected to remote signer");try{return await this.sendRequest("get_capabilities")||[]}catch(e){return console.error("Failed to get capabilities from remote signer:",e),[]}}disconnect(){for(let[e,{reject:t}]of(this.connectionEstablished=!1,this.pendingRequests))t(Error("Disconnected from remote signer")),this.pendingRequests.delete(e);console.log("Disconnected from remote signer")}constructor(e,t){if(this.connectionEstablished=!1,this.pendingRequests=new Map,this.timeout=3e4,e.startsWith("nostrconnect://"))try{let o=new URL(e);this.remotePubkey=o.pathname.substring(1),!t&&o.searchParams.has("relay")?this.relayUrl=o.searchParams.get("relay")||void 0:this.relayUrl=t}catch(e){throw Error("Invalid NIP-47 remote URL format")}else if(e.startsWith("npub1"))try{let o=r.Qe.decode(e);if("npub"!==o.type)throw Error("Invalid NIP-47 remote pubkey format");this.remotePubkey=o.data,this.relayUrl=t}catch(e){throw Error("Invalid NIP-47 remote pubkey format")}else this.remotePubkey=e,this.relayUrl=t;this.clientPrivkey=(0,r.Bq)(),this.clientPubkey=(0,r.lG)(this.clientPrivkey),this.remoteUrl=e}}},6298:(e,t,o)=>{o.d(t,{Y$:()=>d,yX:()=>p});var r=o(5155),n=o(2115),i=o(8839),s=o(3130),a=o(3492);class c{async payInvoice(e){try{if(!e||!e.startsWith("ln"))throw Error("Invalid Lightning invoice format");console.log("Creating payment request for invoice:",e.substring(0,15)+"...");let t={method:"pay_invoice",params:{invoice:e}};return{result:await this.client.sendRequest(t.method,t.params)}}catch(e){return console.error("Payment request failed:",e),{error:{code:e instanceof Error&&"code"in e?e.code:-1,message:e instanceof Error?e.message:String(e)}}}}getPaymentResponseFilter(e){let t={kinds:[24133],"#p":[this.client.getClientPubkey()]};return e&&(t["#e"]=[e]),t}async processPaymentResponse(e){try{let t=await this.client.decryptFromRemote(e.content);return JSON.parse(t)}catch(e){return console.error("Failed to process payment response:",e),{error:{code:-1,message:"Failed to process payment response"}}}}async checkPaymentCapability(){try{if(!this.client.isConnected())return{canPay:!1,reason:"Not connected to remote signer"};if(!(await this.client.getCapabilities()).includes("pay_invoice"))return{canPay:!1,reason:"Remote signer does not support payments"};return{canPay:!0}}catch(e){return console.error("Failed to check payment capability:",e),{canPay:!1,reason:e instanceof Error?e.message:"Unknown error checking payment capability"}}}constructor(e){this.client=e}}let l=e=>e?"".concat(e.substring(0,8),"...").concat(e.substring(e.length-4)):"",u=[{pubkey:"9a0a16254ff0dd29bbe45aeea9b8d80c0b9537d879a93f2589bbacedc4db166e",npub:"npub14jrvanj69ulfxc92pqsunvv220xhwtn6pukpmgpqzg6xl6wmaflqnx6nvs",name:"MadTrips_Official",displayName:"MadTrips (View Only)",picture:"/assets/nostr-icon-purple-transparent-256x256.png"}],h=(0,n.createContext)(void 0),d=e=>{let{children:t}=e,[o,d]=(0,n.useState)(null),[p,y]=(0,n.useState)(null),[g,m]=(0,n.useState)(!0),[f,w]=(0,n.useState)(null),[b,v]=(0,n.useState)(null),[P,E]=(0,n.useState)(null),[R,N]=(0,n.useState)(null),[k,q]=(0,n.useState)(null),[F,I]=(0,n.useState)(!1);(0,n.useEffect)(()=>{(async()=>{try{{let e=new i.Ay({explicitRelayUrls:["wss://relay.damus.io","wss://relay.nostr.band","wss://nos.lol","wss://relay.current.fyi","wss://relay.snort.social"]});await e.connect(),d(e),console.log("NDK initialized without signer"),m(!1)}}catch(e){console.error("Failed to initialize NDK:",e),w(e),m(!1)}})()},[]);let C=async(e,t)=>{if(!o)throw Error("NDK not initialized");m(!0),w(null);try{switch(e){case"nip07":{if(!window.nostr)throw Error("No NIP-07 compatible browser extension found");o.signer=new i.uk;let e=await o.signer.user();if(!e)throw Error("Failed to get public key from extension");let t=o.getUser({npub:e.npub});await t.fetchProfile(),y(t),v("nip07"),E(null),console.log("NIP-07 login successful:",t.npub),I(!1);break}case"nip47":if(!t||!t.target)throw Error("NIP-47 connection requires a target URL");console.log("NIP-47 login requested to:",t.target);try{let e=t.target;e.startsWith("nostrconnect://")?(e=new URL(e).pathname.substring(1)).startsWith("npub1")||(e=s.Qe.npubEncode(e)):e.startsWith("npub1")||(e=s.Qe.npubEncode(e));let r=o.getUser({npub:e}),n=new a.M(t.target);await n.connect(),await n.getPublicKey();let i=new c(n),l=await i.checkPaymentCapability();N(n),q(i),I(l.canPay);try{await r.fetchProfile()}catch(e){console.warn("Could not fetch profile for remote signer:",e)}y(r),v("nip47"),E(null),console.log("NIP-47 login successful:",r.npub),console.log("Payment capability:",l.canPay?"Enabled":"Disabled"),l.canPay||console.warn("Payment not available:",l.reason)}catch(e){throw console.error("NIP-47 login error:",e),Error("NIP-47 login failed: ".concat(e instanceof Error?e.message:"Unknown error"))}break;case"viewonly":{if(!t||!t.profile)throw Error("View-only login requires a profile");let e=t.profile,r=o.getUser({npub:e.npub});try{await r.fetchProfile()}catch(t){console.warn("Could not fetch profile for view-only user, using predefined data"),r.profile={name:e.name,displayName:e.displayName,image:e.picture}}y(r),v("viewonly"),E(e),console.log("View-only login successful:",e.npub),N(null),q(null),I(!1);break}default:throw Error("Unsupported login method: ".concat(e))}}catch(t){throw console.error("Login error (".concat(e,"):"),t),w(t),t}finally{m(!1)}},U=async e=>{if(!o)throw Error("NDK not initialized");let t=o.getUser({npub:e});return await t.fetchProfile(),t},_=async e=>{if(!o)throw Error("NDK not initialized");let t=o.getUser({npub:e});return Array.from(await t.follows()).map(e=>e.npub)},S=async e=>{if(!k)throw Error("Payment client not initialized");if(!F)throw Error("Payments not supported with current login method");try{let t=await k.payInvoice(e);if(t.error)throw Error("Payment failed: ".concat(t.error.message));return t.result}catch(e){throw console.error("Payment failed:",e),e}},x=async function(e){var t,r,n,i,s,a,c,u;let h=arguments.length>1&&void 0!==arguments[1]?arguments[1]:25;if(!o)throw Error("NDK not initialized");try{if(await o.connect(),null===(t=o.pool)||void 0===t?void 0:t.relays){let e=Object.keys(o.pool.relays).length;console.log("Connected to ".concat(e," relays")),0===e&&console.warn("No relays connected. Results may be limited.")}else console.warn("No relay pool available")}catch(e){console.error("Relay connection error:",e)}console.log("Fetching social graph for ".concat(e.length," NPUBs with max ").concat(h," connections"));let d=[],p=[],y=new Map,g=e=>new Promise((t,o)=>setTimeout(()=>o(Error("Operation timed out after ".concat(e,"ms"))),e));for(let t of e)if(!y.has(t))try{let e=o.getUser({npub:t}),a=e.fetchProfile();await Promise.race([a,g(1e4)]),console.log("Fetched profile for ".concat(t,": ").concat((null===(r=e.profile)||void 0===r?void 0:r.name)||"unnamed")),d.push({id:t,npub:t,name:(null===(n=e.profile)||void 0===n?void 0:n.displayName)||(null===(i=e.profile)||void 0===i?void 0:i.name)||l(t),type:"profile",picture:(null===(s=e.profile)||void 0===s?void 0:s.picture)||"",isCoreNode:!0,val:10,group:1}),y.set(t,!0)}catch(e){console.error("Failed to fetch profile for ".concat(t),e),d.push({id:t,npub:t,name:l(t),type:"profile",isCoreNode:!0,val:10,group:1}),y.set(t,!0)}for(let t of e)try{let r=o.getUser({npub:t}).follows(),n=await Promise.race([r,g(15e3)]);console.log("Fetched ".concat(n.size," follows for ").concat(t));let i=Array.from(n).slice(0,h);for(let e of i){if(!e||"object"!=typeof e){console.warn("Invalid followed user:",e);continue}let o=e.npub;if(!o){console.warn("User missing npub:",e);continue}if(y.has(o)){p.push({source:t,target:o,type:"follows",value:1});continue}try{let t=e.fetchProfile();await Promise.race([t,g(5e3)]),d.push({id:o,npub:o,name:(null===(a=e.profile)||void 0===a?void 0:a.displayName)||(null===(c=e.profile)||void 0===c?void 0:c.name)||l(o),type:"connection",picture:(null===(u=e.profile)||void 0===u?void 0:u.picture)||"",isCoreNode:!1,val:3,group:2})}catch(e){console.warn("Failed to fetch profile for follow ".concat(o),e),d.push({id:o,npub:o,name:l(o),type:"connection",isCoreNode:!1,val:3,group:2})}y.set(o,!0),p.push({source:t,target:o,type:"follows",value:1})}let s=new Set(i.map(e=>e.npub));for(let o of e)o!==t&&s.has(o)&&p.push({source:t,target:o,type:"mutual",value:2})}catch(e){console.error("Failed to fetch follows for ".concat(t),e)}return console.log("Completed social graph with ".concat(d.length," nodes and ").concat(p.length," links")),{nodes:d,links:p}};return(0,r.jsx)(h.Provider,{value:{ndk:o,user:p,loading:g,error:f,loginMethod:b,viewOnlyProfile:P,availableProfiles:u,login:C,logout:()=>{if(console.log("NostrContext: Logout initiated"),o)try{o.signer&&(console.log("Resetting NDK signer"),o.signer=void 0),console.log("User resources cleaned up")}catch(e){console.error("Error during logout cleanup:",e)}if(R){try{R.disconnect()}catch(e){console.error("Error disconnecting NIP-47 client:",e)}N(null)}q(null),I(!1),v(null),E(null),y(null),w(null),m(!1),console.log("NostrContext: Logout completed")},getUserProfile:U,getFollows:_,shortenNpub:l,payInvoice:F?S:void 0,canMakePayments:F,getSocialGraph:x},children:t})},p=()=>{let e=(0,n.useContext)(h);if(void 0===e)throw Error("useNostr must be used within a NostrProvider");return e}}}]);
//# sourceMappingURL=298-cc139b66c32143f7.js.map